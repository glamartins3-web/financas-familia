<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Controle Financeiro Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #f0f2f5; padding-top: 70px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .nav-top { background: #1a252f; padding: 12px; position: fixed; top: 0; width: 100%; z-index: 1000; display: flex; justify-content: center; gap: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .container-box { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .hidden { display: none !important; }
        .card-resumo { border-radius: 12px; color: white; padding: 15px; text-align: center; }
        .bg-receita { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .bg-despesa { background: linear-gradient(135deg, #e74c3c, #ff7675); }
        .bg-saldo { background: linear-gradient(135deg, #2c3e50, #34495e); }
        .val-receita { color: #27ae60; font-weight: bold; }
        .val-despesa { color: #e74c3c; font-weight: bold; }
        .status-pago { color: #27ae60; font-weight: bold; font-size: 0.8rem; }
        .status-pendente { color: #f39c12; font-weight: bold; font-size: 0.8rem; }
        .data-pagamento { font-size: 0.65rem; color: #7f8c8d; display: block; }
        .btn-edit { color: #3498db; cursor: pointer; border: none; background: none; font-size: 1.1rem; }
        .btn-del { color: #e74c3c; cursor: pointer; border: none; background: none; font-size: 1.1rem; }
        label { font-size: 0.75rem; text-transform: uppercase; color: #7f8c8d; font-weight: bold; }
        .month-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 8px; margin-top: 10px; }
        .btn-month { border: 1px solid #dee2e6; background: white; padding: 8px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; }
        .btn-month.active { background: #1a252f; color: white; border-color: #1a252f; }
        .tabela-totais { background-color: #f8f9fa; font-weight: bold; }
        .badge-user { font-size: 0.7rem; background: #e9ecef; color: #495057; padding: 2px 5px; border-radius: 4px; }
        #tela-login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a252f; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; }
        
        /* Estilos Novos para o Painel de Status */
        .status-texto { font-size: 0.85rem; font-weight: bold; margin-bottom: 2px; }
        .status-valor { font-size: 0.9rem; font-weight: normal; }
    </style>
</head>
<body>

<div id="tela-login">
    <div class="login-box">
        <h4 class="fw-bold mb-3">ACESSO RESTRITO</h4>
        <input type="text" id="user-input" class="form-control mb-2" placeholder="UsuÃ¡rio">
        <input type="password" id="pass-input" class="form-control mb-3" placeholder="Senha">
        <button class="btn btn-dark w-100 fw-bold" onclick="fazerLogin()">ENTRAR</button>
        <div id="login-error" class="text-danger mt-2 small hidden">Dados invÃ¡lidos!</div>
    </div>
</div>

<div id="app-content" class="hidden">
    <nav class="nav-top">
        <button class="btn btn-light btn-sm px-4 fw-bold" onclick="showPage('historia')">ğŸ“Š HISTÃ“RICO</button>
        <button class="btn btn-light btn-sm px-4 fw-bold" onclick="showPage('lancamentos')">ğŸ’¸ LANÃ‡AMENTOS</button>
        <button class="btn btn-outline-danger btn-sm border-0" onclick="logout()">Logout</button>
    </nav>

    <div id="pg-historia" class="container">
        <div class="container-box">
            <div class="row g-2 align-items-end">
                <div class="col-6 col-md-3"><label>ğŸ“… Filtrar Ano</label><select id="filtro-ano-hist" class="form-select" onchange="render()"></select></div>
                <div class="col-6 col-md-3"><label>ğŸŒ“ PerÃ­odo</label>
                    <select id="filtro-semestre" class="form-select" onchange="render()">
                        <option value="todos">Ano Inteiro</option>
                        <option value="1">1Âº Semestre</option>
                        <option value="2">2Âº Semestre</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="container-box text-center">
            <h5 class="fw-bold mb-3">ğŸ“ˆ EVOLUÃ‡ÃƒO E PROJEÃ‡ÃƒO</h5>
            <div style="height: 300px;"><canvas id="chartHist"></canvas></div>
        </div>
        <div class="container-box table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-dark"><tr><th>ğŸ—“ï¸ MÃªs/Ano</th><th>ğŸ“ˆ Receita</th><th>ğŸ“‰ Despesa</th><th>ğŸ’° Saldo</th></tr></thead>
                <tbody id="corpo-historia"></tbody>
                <tfoot id="total-historia" class="tabela-totais"></tfoot>
            </table>
        </div>
    </div>

    <div id="pg-lancamentos" class="container hidden">
        <div class="container-box">
            <div class="d-flex align-items-center gap-2">
                <label class="mb-0">ğŸ” Selecionar MÃªs e Ano</label>
                <select id="f-ano-lanc" class="form-select form-select-sm w-auto" onchange="initMonthSelector()"></select>
            </div>
            <div class="month-grid" id="month-selector"></div>
            <input type="hidden" id="mes-foco">
        </div>

        <div class="row g-2 mb-3">
            <div class="col-md-6">
                <div class="container-box py-2 h-100 bg-light mb-0">
                    <label class="d-block mb-2">ğŸ’¾ ManutenÃ§Ã£o de Dados (Backup)</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm w-100 fw-bold" onclick="document.getElementById('inputImport').click()">ğŸ“¥ IMPORTAR</button>
                        <button class="btn btn-success btn-sm w-100 fw-bold" onclick="exportarExcel()">ğŸ“— EXCEL</button>
                        <button class="btn btn-secondary btn-sm w-100 fw-bold" onclick="exportarTXT()">ğŸ“„ BACKUP</button>
                        <input type="file" id="inputImport" class="hidden" accept=".txt" onchange="importarDados(this)">
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="container-box py-2 h-100 mb-0 border-start border-4 border-primary">
                    <div class="status-texto">ğŸ“Š STATUS: <span id="stat-porcent">0%</span></div>
                    <div class="progress mb-2" style="height: 8px;">
                        <div id="stat-bar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="status-texto text-success">âœ… Pago: <span id="stat-pago" class="status-valor">R$ 0.00 (0)</span></div>
                    <div class="status-texto text-warning">â³ Falta: <span id="stat-falta" class="status-valor">R$ 0.00</span></div>
                </div>
            </div>
        </div>

        <div class="row g-2 mb-3 text-uppercase fw-bold">
            <div class="col-4"><div class="card-resumo bg-receita"><small>Ganhos</small><div id="res-rec">R$ 0</div></div></div>
            <div class="col-4"><div class="card-resumo bg-despesa"><small>Gastos</small><div id="res-des">R$ 0</div></div></div>
            <div class="col-4"><div class="card-resumo bg-saldo"><small>Sobra</small><div id="res-sal">R$ 0</div></div></div>
        </div>

        <div class="container-box">
            <input type="hidden" id="edit-id">
            <input type="hidden" id="edit-group">
            <div class="row g-2">
                <div class="col-6 col-md-2"><label>ğŸ“… Data</label><input type="date" id="f-data" class="form-control"></div>
                <div class="col-6 col-md-3"><label>ğŸ“ DescriÃ§Ã£o</label><input type="text" id="f-desc" class="form-control" placeholder="Ex: IPVA"></div>
                <div class="col-6 col-md-2"><label>ğŸ’µ Valor</label><input type="number" id="f-valor" class="form-control" placeholder="0.00"></div>
                <div class="col-6 col-md-2"><label>âš™ï¸ Tipo</label>
                    <select id="f-tipo" class="form-select"><option value="Receita">Receita</option><option value="Despesa" selected>Despesa</option></select>
                </div>
                <div class="col-12 col-md-3 d-flex align-items-end"><button id="btn-main" class="btn btn-dark w-100 fw-bold" onclick="adicionar()">â• INCLUIR</button></div>
                <div class="col-12 mt-2">
                    <input type="checkbox" id="f-rec-check" onchange="document.getElementById('box-parc').classList.toggle('hidden', !this.checked)"> ğŸ” Parcelar / Recorrente?
                    <div id="box-parc" class="hidden mt-2 p-2 border rounded bg-light"><label>Quantidade total de parcelas</label><input type="number" id="f-parc" class="form-control w-25" value="1"></div>
                </div>
                <div class="col-12 mt-2"><button class="btn btn-outline-primary btn-sm w-100 fw-bold" data-bs-toggle="modal" data-bs-target="#modalSalario">ğŸ’° LANÃ‡AR SALÃRIO / ADIANTAMENTO</button></div>
            </div>
        </div>

        <div class="container-box table-responsive">
            <table class="table table-sm align-middle table-hover">
                <thead class="table-light"><tr><th>Pago</th><th>Data/DescriÃ§Ã£o</th><th>Valor</th><th>UsuÃ¡rio</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead>
                <tbody id="corpo-itens" class="small"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSalario" tabindex="-1">
  <div class="modal-dialog modal-sm"><div class="modal-content">
      <div class="modal-header bg-primary text-white"><h5>ğŸ’° Entradas</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><label>ğŸ’µ SalÃ¡rio (Dia 05)</label><input type="number" id="sal-05" class="form-control mb-3"><label>ğŸ’µ Adiantamento (Dia 20)</label><input type="number" id="sal-20" class="form-control"></div>
      <div class="modal-footer"><button class="btn btn-primary w-100" onclick="salvarSalario()" data-bs-dismiss="modal">SALVAR RECEITAS</button></div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const URL_GOOGLE_SCRIPT = "https://script.google.com/macros/s/AKfycbxfrfSxrBvOXPRdJWS7FKPPsqnznsM-Wsd2z-X6jRFS020h8L9MC_C1CpbRdFReDhYa/exec";
    const USUARIOS_PERMITIDOS = { "admin": "123", "glauber": "1912", "suelen": "1009" };

    let db = JSON.parse(localStorage.getItem('financas_pro_v6')) || [];
    let chartH = null;
    let userNow = "";

    function fazerLogin() {
        const u = document.getElementById('user-input').value.toLowerCase();
        const p = document.getElementById('pass-input').value;
        if (USUARIOS_PERMITIDOS[u] === p) {
            userNow = u; sessionStorage.setItem('user_fin', u);
            document.getElementById('tela-login').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            initFilters(); initMonthSelector(); render();
        } else { document.getElementById('login-error').classList.remove('hidden'); }
    }
    function logout() { sessionStorage.clear(); location.reload(); }

    function initFilters() {
        const ano = new Date().getFullYear();
        ['filtro-ano-hist', 'f-ano-lanc'].forEach(id => {
            const s = document.getElementById(id); if(!s) return;
            s.innerHTML = "";
            for(let i = ano - 1; i <= ano + 2; i++) s.innerHTML += `<option value="${i}" ${i === ano ? 'selected' : ''}>${i}</option>`;
        });
    }

    function initMonthSelector() {
        const grid = document.getElementById('month-selector'); if(!grid) return;
        const ano = document.getElementById('f-ano-lanc').value;
        const meses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        grid.innerHTML = "";
        meses.forEach((m, i) => {
            const val = `${ano}-${String(i+1).padStart(2, '0')}`;
            grid.innerHTML += `<button class="btn-month ${i === new Date().getMonth() ? 'active' : ''}" onclick="setMesFoco('${val}', this)">${m}</button>`;
        });
        document.getElementById('mes-foco').value = `${ano}-${String(new Date().getMonth()+1).padStart(2, '0')}`;
        render();
    }

    function setMesFoco(v, b) {
        document.querySelectorAll('.btn-month').forEach(x => x.classList.remove('active'));
        b.classList.add('active'); document.getElementById('mes-foco').value = v; render();
    }

    function showPage(p) {
        document.getElementById('pg-historia').classList.toggle('hidden', p !== 'historia');
        document.getElementById('pg-lancamentos').classList.toggle('hidden', p !== 'lancamentos');
        render();
    }

    function adicionar() {
        const id = document.getElementById('edit-id').value;
        const gid = document.getElementById('edit-group').value;
        const data = document.getElementById('f-data').value;
        const desc = document.getElementById('f-desc').value;
        const valor = parseFloat(document.getElementById('f-valor').value);
        const tipo = document.getElementById('f-tipo').value;
        const isRec = document.getElementById('f-rec-check').checked;
        const novaQtdTotal = parseInt(document.getElementById('f-parc').value) || 1;

        if (!data || isNaN(valor)) return alert("Preencha Data e Valor!");

        if (id && gid && gid !== "null") {
            if (confirm("Deseja aplicar as mudanÃ§as ao grupo de parcelas futuras?")) {
                let grupoCompleto = db.filter(x => x.groupId == gid).sort((a,b) => new Date(a.data) - new Date(b.data));
                let indexAtualNoGrupo = grupoCompleto.findIndex(x => x.id == id);
                let numeroParcelaAtual = indexAtualNoGrupo + 1;
                if (novaQtdTotal < numeroParcelaAtual) { alert("A quantidade total nÃ£o pode ser menor que a parcela atual!"); return; }

                for (let i = 0; i < novaQtdTotal; i++) {
                    let d = new Date(data + "T00:00:00");
                    d.setMonth(d.getMonth() + (i - indexAtualNoGrupo));
                    let dataString = d.toISOString().split('T')[0];
                    let descFormat = desc + ` [${i+1}/${novaQtdTotal}]`;
                    if (grupoCompleto[i]) {
                        let idxNoDb = db.findIndex(x => x.id == grupoCompleto[i].id);
                        db[idxNoDb] = { ...db[idxNoDb], data: dataString, desc: descFormat, valor, tipo, user: userNow };
                    } else {
                        db.push({ id: Date.now() + i, groupId: gid, data: dataString, desc: descFormat, valor, tipo, pago: false, user: userNow });
                    }
                }
                if (grupoCompleto.length > novaQtdTotal) {
                    let idsParaRemover = grupoCompleto.slice(novaQtdTotal).map(x => x.id);
                    db = db.filter(x => !idsParaRemover.includes(x.id));
                }
            } else {
                let idx = db.findIndex(x => x.id == id);
                db[idx] = { ...db[idx], data, desc, valor, tipo, user: userNow };
            }
        } else if (id) {
            let idx = db.findIndex(x => x.id == id);
            if (isRec) {
                db.splice(idx, 1);
                const newGid = "G" + Date.now();
                for(let i=0; i<novaQtdTotal; i++){
                    let d = new Date(data + "T00:00:00"); d.setMonth(d.getMonth() + i);
                    db.push({ id: Date.now()+i, groupId: newGid, data: d.toISOString().split('T')[0], desc: desc + ` [${i+1}/${novaQtdTotal}]`, valor, tipo, pago: false, user: userNow });
                }
            } else {
                db[idx] = { ...db[idx], data, desc, valor, tipo, user: userNow };
            }
        } else {
            const newGid = isRec ? "G" + Date.now() : null;
            for(let i=0; i<novaQtdTotal; i++){
                let d = new Date(data + "T00:00:00"); d.setMonth(d.getMonth() + i);
                db.push({ id: Date.now()+i, groupId: newGid, data: d.toISOString().split('T')[0], desc: desc + (isRec?` [${i+1}/${novaQtdTotal}]`:""), valor, tipo, pago: false, user: userNow });
            }
        }
        salvar(); limpar();
    }

    function editar(id) {
        let it = db.find(x => x.id == id);
        document.getElementById('edit-id').value = it.id;
        document.getElementById('edit-group').value = it.groupId;
        document.getElementById('f-data').value = it.data;
        document.getElementById('f-desc').value = it.desc.split(' [')[0];
        document.getElementById('f-valor').value = it.valor;
        document.getElementById('f-tipo').value = it.tipo;
        if (it.groupId) {
            const grupo = db.filter(x => x.groupId == it.groupId);
            document.getElementById('f-rec-check').checked = true;
            document.getElementById('f-parc').value = grupo.length;
            document.getElementById('box-parc').classList.remove('hidden');
        } else { 
            document.getElementById('f-rec-check').checked = false; 
            document.getElementById('box-parc').classList.add('hidden'); 
        }
        const btn = document.getElementById('btn-main');
        btn.innerText = "âœï¸ SALVAR"; btn.classList.replace('btn-dark', 'btn-success');
        window.scrollTo(0,0);
    }

    function salvarSalario() {
        const v5 = parseFloat(document.getElementById('sal-05').value) || 0;
        const v20 = parseFloat(document.getElementById('sal-20').value) || 0;
        const mes = document.getElementById('mes-foco').value;
        if(v5 > 0) db.push({ id: Date.now()+1, data: mes+"-05", desc: "SalÃ¡rio", valor: v5, tipo: "Receita", pago: true, user: userNow });
        if(v20 > 0) db.push({ id: Date.now()+2, data: mes+"-20", desc: "Adiantamento", valor: v20, tipo: "Receita", pago: true, user: userNow });
        salvar();
    }

    function togglePago(id) {
        let it = db.find(x => x.id == id);
        it.pago = !it.pago;
        it.dataPagto = it.pago ? new Date().toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : null;
        salvar();
    }

    function salvar() { 
        localStorage.setItem('financas_pro_v6', JSON.stringify(db)); 
        render(); 
        fetch(URL_GOOGLE_SCRIPT, { 
            method: 'POST', 
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(db) 
        }).catch(err => console.log("Erro ao sincronizar planilha"));
    }

    function limpar() { 
        document.getElementById('edit-id').value = ""; document.getElementById('edit-group').value = "";
        document.getElementById('f-desc').value = ""; document.getElementById('f-valor').value = "";
        const btn = document.getElementById('btn-main'); btn.innerText = "â• INCLUIR"; btn.classList.replace('btn-success', 'btn-dark');
        document.getElementById('f-rec-check').checked = false; document.getElementById('box-parc').classList.add('hidden');
    }

    function deletar(id) { if(confirm("Excluir?")) { db = db.filter(x => x.id != id); salvar(); } }

    function render() {
        const mesF = document.getElementById('mes-foco').value;
        const anoH = document.getElementById('filtro-ano-hist').value;
        const semH = document.getElementById('filtro-semestre').value;
        const cI = document.getElementById('corpo-itens');
        const cH = document.getElementById('corpo-historia');
        const fH = document.getElementById('total-historia');
        if(!cI) return;
        cI.innerHTML = ""; cH.innerHTML = "";
        
        let rM = 0, dM = 0, hist = {}, tR = 0, tD = 0;
        let vPagoMÃªs = 0, vFaltaMÃªs = 0, qtdPagoMÃªs = 0;

        db.sort((a,b) => new Date(a.data) - new Date(b.data)).forEach(it => {
            const mD = it.data.substring(0,7);
            const aD = it.data.substring(0,4);
            const mN = parseInt(it.data.substring(5,7));
            
            if(aD === anoH) {
                if(semH === "todos" || (semH === "1" && mN <= 6) || (semH === "2" && mN > 6)) {
                    if(!hist[mD]) hist[mD] = {r:0, d:0};
                    if(it.tipo === "Receita") hist[mD].r += it.valor; else hist[mD].d += it.valor;
                }
            }
            
            if(mD === mesF) {
                if(it.tipo === "Receita") {
                    rM += it.valor;
                } else {
                    dM += it.valor;
                    // CÃ¡lculo para o painel de Status (Somente Despesas)
                    if(it.pago) {
                        vPagoMÃªs += it.valor;
                        qtdPagoMÃªs++;
                    } else {
                        vFaltaMÃªs += it.valor;
                    }
                }
                
                cI.innerHTML += `<tr>
                    <td><input type="checkbox" class="form-check-input" ${it.pago?'checked':''} onclick="togglePago(${it.id})"></td>
                    <td><b>${it.data.split('-').reverse().join('/')}</b><br>${it.desc}</td>
                    <td class="${it.tipo==='Receita'?'val-receita':'val-despesa'}">R$ ${it.valor.toFixed(2)}</td>
                    <td><span class="badge-user">${it.user || '---'}</span></td>
                    <td>${it.pago ? `<span class="status-pago">âœ… PAGO</span><small class="data-pagamento">${it.dataPagto}</small>` : `<span class="status-pendente">â³ PENDENTE</span>`}</td>
                    <td><button class="btn-edit" onclick="editar(${it.id})">âœï¸</button><button class="btn-del" onclick="deletar(${it.id})">ğŸ—‘ï¸</button></td>
                </tr>`;
            }
        });

        // Atualizar painel de Status
        const perc = dM > 0 ? (vPagoMÃªs / dM) * 100 : 0;
        document.getElementById('stat-porcent').innerText = Math.round(perc) + "%";
        document.getElementById('stat-bar').style.width = perc + "%";
        document.getElementById('stat-pago').innerText = `R$ ${vPagoMÃªs.toFixed(2)} (${qtdPagoMÃªs})`;
        document.getElementById('stat-falta').innerText = `R$ ${vFaltaMÃªs.toFixed(2)}`;

        Object.keys(hist).sort().reverse().forEach(m => {
            const s = hist[m]; tR += s.r; tD += s.d;
            cH.innerHTML += `<tr><td>ğŸ—“ï¸ ${m}</td><td class="val-receita">R$ ${s.r.toFixed(2)}</td><td class="val-despesa">R$ ${s.d.toFixed(2)}</td><td class="fw-bold">R$ ${(s.r-s.d).toFixed(2)}</td></tr>`;
        });
        
        if(fH) fH.innerHTML = `<tr><td>SOMA PERÃODO</td><td class="val-receita">R$ ${tR.toFixed(2)}</td><td class="val-despesa">R$ ${tD.toFixed(2)}</td><td class="bg-dark text-white">R$ ${(tR-tD).toFixed(2)}</td></tr>`;
        
        document.getElementById('res-rec').innerText = "R$ " + rM.toFixed(2);
        document.getElementById('res-des').innerText = "R$ " + dM.toFixed(2);
        document.getElementById('res-sal').innerText = "R$ " + (rM - dM).toFixed(2);

        if(chartH) chartH.destroy();
        const ctx = document.getElementById('chartHist');
        if(ctx) {
            chartH = new Chart(ctx, {
                data: {
                    labels: Object.keys(hist).sort(),
                    datasets: [
                        { type: 'line', label: 'Saldo', data: Object.keys(hist).sort().map(l => hist[l].r - hist[l].d), borderColor: '#2c3e50', tension: 0.3 },
                        { type: 'bar', label: 'Ganhos', data: Object.keys(hist).sort().map(l => hist[l].r), backgroundColor: '#27ae60' },
                        { type: 'bar', label: 'Gastos', data: Object.keys(hist).sort().map(l => hist[l].d), backgroundColor: '#e74c3c' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    }

    function exportarExcel() {
        let csv = "Data;Descricao;Valor;Tipo;Status;Usuario\n";
        db.forEach(i => csv += `${i.data};${i.desc};${i.valor.toFixed(2)};${i.tipo};${i.pago?'Pago':'Pendente'};${i.user}\n`);
        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv' });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "financeiro.csv"; a.click();
    }
    function exportarTXT() {
        const blob = new Blob([JSON.stringify(db, null, 2)], { type: 'text/plain' });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "backup.txt"; a.click();
    }
    function importarDados(input) {
        const reader = new FileReader();
        reader.onload = (e) => { try { db = JSON.parse(e.target.result); salvar(); alert("Importado!"); } catch(e){alert("Erro!");} };
        reader.readAsText(input.files[0]);
    }

    window.onload = () => { 
        initFilters(); initMonthSelector(); 
        const s = sessionStorage.getItem('user_fin');
        if(s) { userNow = s; document.getElementById('tela-login').classList.add('hidden'); document.getElementById('app-content').classList.remove('hidden'); render(); }
    };
</script>
</body>
</html>
