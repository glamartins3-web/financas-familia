<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f0f2f5;
  --dark:#1a252f;
}
body{
  background:var(--bg);
  font-family:'Segoe UI',Tahoma,sans-serif;
  padding-top:64px;
}
.hidden{display:none!important}

/* NAV */
.nav-top{
  position:fixed;
  top:0;
  width:100%;
  background:var(--dark);
  padding:10px;
  display:flex;
  justify-content:space-around;
  z-index:1000;
}

/* BOX */
.container-box{
  background:#fff;
  border-radius:16px;
  padding:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  margin-bottom:16px;
}

/* LOGIN */
#tela-login{
  position:fixed;
  inset:0;
  background:var(--dark);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.login-box{
  background:#fff;
  padding:24px;
  border-radius:18px;
  max-width:360px;
  width:100%;
}

/* RESUMO */
.card-resumo{
  border-radius:14px;
  padding:14px;
  color:#fff;
  text-align:center;
  font-weight:bold;
}
.bg-receita{background:linear-gradient(135deg,#2ecc71,#27ae60)}
.bg-despesa{background:linear-gradient(135deg,#ff7675,#e74c3c)}
.bg-saldo{background:linear-gradient(135deg,#6c5ce7,#341f97)}

.val-receita{color:#27ae60;font-weight:bold}
.val-despesa{color:#e74c3c;font-weight:bold}
.status-pago{color:#27ae60;font-weight:bold}
.status-pendente{color:#f39c12;font-weight:bold}

/* CALEND√ÅRIO */
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
}
.calendar div{
  background:#fff;
  border-radius:10px;
  padding:10px 0;
  text-align:center;
  font-weight:bold;
  border:1px solid #ddd;
}
.calendar .active{
  background:var(--dark);
  color:#fff;
}
.calendar .has-item{
  border:2px solid #27ae60;
}

/* MOBILE */
@media(min-width:768px){
  .nav-top{justify-content:center;gap:12px}
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="tela-login">
  <div class="login-box text-center">
    <h4 class="fw-bold mb-3">ACESSO RESTRITO</h4>
    <input id="userInput" class="form-control mb-2" placeholder="Usu√°rio">
    <input id="passInput" type="password" class="form-control mb-3" placeholder="Senha">
    <button class="btn btn-dark w-100 fw-bold" onclick="fazerLogin()">ENTRAR</button>
    <div id="loginError" class="text-danger mt-2 small hidden">Dados inv√°lidos</div>
  </div>
</div>

<!-- APP -->
<div id="appContent" class="hidden">

<nav class="nav-top">
  <button class="btn btn-light btn-sm fw-bold" onclick="showPage('lan')">üí∏</button>
  <button class="btn btn-light btn-sm fw-bold" onclick="showPage('hist')">üìä</button>
  <button class="btn btn-outline-danger btn-sm" onclick="logout()">‚éã</button>
</nav>

<!-- LAN√áAMENTOS -->
<div id="pg-lan" class="container">

  <div class="container-box">
    <h6 class="fw-bold mb-2">Calend√°rio Mensal</h6>
    <div id="calendar" class="calendar"></div>
    <input type="hidden" id="mesFoco">
  </div>

  <div class="row g-2 mb-2">
    <div class="col-4"><div class="card-resumo bg-receita">Receitas<br><span id="resRec">R$0</span></div></div>
    <div class="col-4"><div class="card-resumo bg-despesa">Despesas<br><span id="resDes">R$0</span></div></div>
    <div class="col-4"><div class="card-resumo bg-saldo">Saldo<br><span id="resSal">R$0</span></div></div>
  </div>

  <div class="container-box">
    <div class="row g-2">
      <div class="col-6"><input id="fData" type="date" class="form-control"></div>
      <div class="col-6"><input id="fValor" type="number" class="form-control" placeholder="Valor"></div>
      <div class="col-12"><input id="fDesc" class="form-control" placeholder="Descri√ß√£o"></div>
      <div class="col-6">
        <select id="fTipo" class="form-select">
          <option>Receita</option>
          <option>Despesa</option>
        </select>
      </div>
      <div class="col-6">
        <select id="fRecorrente" class="form-select">
          <option value="N">√önica</option>
          <option value="S">Recorrente</option>
        </select>
      </div>
      <div class="col-12">
        <button class="btn btn-dark w-100 fw-bold" onclick="adicionar()">INCLUIR</button>
      </div>
    </div>
  </div>

  <div class="container-box table-responsive">
    <table class="table table-sm">
      <thead><tr><th>‚úì</th><th>Descri√ß√£o</th><th>Valor</th></tr></thead>
      <tbody id="corpoItens"></tbody>
    </table>
  </div>
</div>

<!-- HIST√ìRICO -->
<div id="pg-hist" class="container hidden">

  <div class="container-box">
    <canvas id="graficoMensal" height="160"></canvas>
  </div>

  <div class="container-box table-responsive">
    <table class="table">
      <thead class="table-dark">
        <tr><th>M√™s</th><th>Receita</th><th>Despesa</th><th>Saldo</th></tr>
      </thead>
      <tbody id="corpoHist"></tbody>
    </table>
  </div>

</div>
</div>

<script>
const URL_API="https://script.google.com/macros/s/AKfycbxHjTzh9gF0yfw9LW7EGYTAshfKQJyRV7TCmhmJIQr9pVw4f00bmnZpwbhvtO2e7Fon5Q/exec";

const $=id=>document.getElementById(id);
let db=[],userNow="",grafico;

/* NAV */
function showPage(p){
  $("pg-lan").classList.toggle("hidden",p!=="lan");
  $("pg-hist").classList.toggle("hidden",p!=="hist");
}

/* LOGIN */
async function fazerLogin(){
  $("loginError").classList.add("hidden");
  const r=await fetch(`${URL_API}?action=login&user=${encodeURIComponent($("userInput").value)}&pass=${encodeURIComponent($("passInput").value)}`);
  const j=await r.json();
  if(!j.ok) return $("loginError").classList.remove("hidden");
  userNow=j.usuario;
  $("tela-login").classList.add("hidden");
  $("appContent").classList.remove("hidden");
  carregar();
}
function logout(){location.reload();}

/* DADOS */
async function carregar(){
  const r=await fetch(`${URL_API}?action=listar`);
  const d=await r.json();
  db=d.map(l=>({id:l[0],data:l[2],desc:l[3],valor:+l[4],tipo:l[5],pago:l[6]==="PAGO"}));
  render();
  renderHistorico();
  renderCalendario();
}

/* CALEND√ÅRIO */
function renderCalendario(){
  const cal=$("calendar");
  cal.innerHTML="";
  const d=new Date(),y=d.getFullYear(),m=d.getMonth()+1;
  $("mesFoco").value=`${y}-${String(m).padStart(2,"0")}`;
  for(let i=1;i<=31;i++){
    const data=`${$("mesFoco").value}-${String(i).padStart(2,"0")}`;
    const tem=db.some(x=>x.data===data);
    cal.innerHTML+=`<div class="${tem?'has-item':''}">${i}</div>`;
  }
}

/* CRUD */
function adicionar(){
  db.push({
    id:Date.now(),
    data:$("fData").value,
    desc:$("fDesc").value,
    valor:+$("fValor").value,
    tipo:$("fTipo").value,
    pago:false
  });
  salvar();
}
async function salvar(){
  await fetch(URL_API,{method:"POST",body:JSON.stringify(db)});
  render();renderHistorico();renderCalendario();
}

/* RENDER */
function render(){
  let r=0,d=0;
  $("corpoItens").innerHTML="";
  db.filter(x=>x.data.startsWith($("mesFoco").value)).forEach(i=>{
    i.tipo==="Receita"?r+=i.valor:d+=i.valor;
    $("corpoItens").innerHTML+=`
    <tr>
      <td><input type="checkbox" ${i.pago?"checked":""}></td>
      <td>${i.desc}</td>
      <td class="${i.tipo==="Receita"?"val-receita":"val-despesa"}">R$ ${i.valor.toFixed(2)}</td>
    </tr>`;
  });
  $("resRec").innerText=`R$ ${r.toFixed(2)}`;
  $("resDes").innerText=`R$ ${d.toFixed(2)}`;
  $("resSal").innerText=`R$ ${(r-d).toFixed(2)}`;
}

/* HIST√ìRICO + GR√ÅFICO */
function renderHistorico(){
  const hist={};$("corpoHist").innerHTML="";
  db.forEach(i=>{
    const m=i.data.slice(0,7);
    hist[m]=hist[m]||{r:0,d:0};
    i.tipo==="Receita"?hist[m].r+=i.valor:hist[m].d+=i.valor;
  });
  const meses=Object.keys(hist).sort();
  meses.forEach(m=>{
    const s=hist[m].r-hist[m].d;
    $("corpoHist").innerHTML+=`
    <tr><td>${m}</td>
    <td class="val-receita">R$ ${hist[m].r.toFixed(2)}</td>
    <td class="val-despesa">R$ ${hist[m].d.toFixed(2)}</td>
    <td>R$ ${s.toFixed(2)}</td></tr>`;
  });
  const ctx=$("graficoMensal").getContext("2d");
  if(grafico)grafico.destroy();
  grafico=new Chart(ctx,{
    type:"line",
    data:{labels:meses,datasets:[
      {label:"Receitas",data:meses.map(m=>hist[m].r),borderColor:"#27ae60"},
      {label:"Despesas",data:meses.map(m=>hist[m].d),borderColor:"#e74c3c"}
    ]},
    options:{responsive:true,plugins:{legend:{position:"bottom"}}}
  });
}
</script>

</body>
</html>
