<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#f0f2f5;font-family:'Segoe UI',Tahoma,sans-serif;padding-top:70px}
.hidden{display:none!important}
.nav-top{position:fixed;top:0;width:100%;background:#1a252f;padding:12px;display:flex;justify-content:center;gap:10px;z-index:1000}
.container-box{background:#fff;border-radius:16px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,.08);margin-bottom:20px}
#tela-login{position:fixed;inset:0;background:#1a252f;display:flex;align-items:center;justify-content:center;z-index:9999}
.login-box{background:#fff;padding:30px;border-radius:18px;max-width:360px;width:100%}
.card-resumo{border-radius:16px;padding:18px;color:#fff;text-align:center;font-weight:bold}
.bg-receita{background:linear-gradient(135deg,#2ecc71,#27ae60)}
.bg-despesa{background:linear-gradient(135deg,#ff7675,#e74c3c)}
.bg-saldo{background:linear-gradient(135deg,#6c5ce7,#341f97)}
.val-receita{color:#27ae60;font-weight:bold}
.val-despesa{color:#e74c3c;font-weight:bold}
.status-pago{color:#27ae60;font-weight:bold}
.status-pendente{color:#f39c12;font-weight:bold}
.month-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:8px}
.btn-month{border:1px solid #ddd;border-radius:10px;padding:8px;background:#fff;font-weight:bold}
.btn-month.active{background:#1a252f;color:#fff}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="tela-login">
  <div class="login-box text-center">
    <h4 class="fw-bold mb-3">ACESSO RESTRITO</h4>
    <input id="userInput" class="form-control mb-2" placeholder="UsuÃ¡rio">
    <input id="passInput" type="password" class="form-control mb-3" placeholder="Senha">
    <button class="btn btn-dark w-100 fw-bold" onclick="fazerLogin()">ENTRAR</button>
    <div id="loginError" class="text-danger mt-2 small hidden">Dados invÃ¡lidos</div>
  </div>
</div>

<!-- APP -->
<div id="appContent" class="hidden">

<nav class="nav-top">
  <button class="btn btn-light btn-sm fw-bold" onclick="showPage('lan')">ðŸ’¸ LANÃ‡AMENTOS</button>
  <button class="btn btn-light btn-sm fw-bold" onclick="showPage('hist')">ðŸ“Š HISTÃ“RICO</button>
  <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
</nav>

<!-- LANÃ‡AMENTOS -->
<div id="pg-lan" class="container">

  <div class="container-box">
    <div id="monthSelector" class="month-grid"></div>
    <input type="hidden" id="mesFoco">
  </div>

  <div class="row g-2 mb-3">
    <div class="col-4"><div class="card-resumo bg-receita">Receitas<br><span id="resRec">R$0</span></div></div>
    <div class="col-4"><div class="card-resumo bg-despesa">Despesas<br><span id="resDes">R$0</span></div></div>
    <div class="col-4"><div class="card-resumo bg-saldo">Saldo<br><span id="resSal">R$0</span></div></div>
  </div>

  <div class="container-box">
    <div class="row g-2">
      <div class="col-md-3"><input id="fData" type="date" class="form-control"></div>
      <div class="col-md-4"><input id="fDesc" class="form-control" placeholder="DescriÃ§Ã£o"></div>
      <div class="col-md-2"><input id="fValor" type="number" class="form-control" placeholder="Valor"></div>
      <div class="col-md-3">
        <select id="fTipo" class="form-select">
          <option>Receita</option>
          <option>Despesa</option>
        </select>
      </div>
      <div class="col-12">
        <button class="btn btn-dark w-100 fw-bold mt-2" onclick="adicionar()">INCLUIR</button>
      </div>
    </div>
  </div>

  <div class="container-box table-responsive">
    <table class="table table-sm table-hover">
      <thead><tr><th>Pago</th><th>DescriÃ§Ã£o</th><th>Valor</th><th>Status</th></tr></thead>
      <tbody id="corpoItens"></tbody>
    </table>
  </div>
</div>

<!-- HISTÃ“RICO -->
<div id="pg-hist" class="container hidden">

  <div class="container-box">
    <h5 class="fw-bold mb-3">HistÃ³rico Mensal</h5>
    <div style="height:300px">
      <canvas id="chartHist"></canvas>
    </div>
  </div>

  <div class="container-box table-responsive">
    <table class="table table-hover">
      <thead class="table-dark">
        <tr>
          <th>MÃªs/Ano</th>
          <th>Receita</th>
          <th>Despesa</th>
          <th>Saldo</th>
        </tr>
      </thead>
      <tbody id="corpoHist"></tbody>
    </table>
  </div>
</div>

</div>

<script>
/* ========= CONFIG ========= */
const URL_API="https://script.google.com/macros/s/AKfycbxHjTzh9gF0yfw9LW7EGYTAshfKQJyRV7TCmhmJIQr9pVw4f00bmnZpwbhvtO2e7Fon5Q/exec";

/* ========= DOM ========= */
const userInput=document.getElementById("userInput");
const passInput=document.getElementById("passInput");
const telaLogin=document.getElementById("tela-login");
const appContent=document.getElementById("appContent");
const loginError=document.getElementById("loginError");

const monthSelector=document.getElementById("monthSelector");
const mesFoco=document.getElementById("mesFoco");

const fData=document.getElementById("fData");
const fDesc=document.getElementById("fDesc");
const fValor=document.getElementById("fValor");
const fTipo=document.getElementById("fTipo");

const corpoItens=document.getElementById("corpoItens");
const resRec=document.getElementById("resRec");
const resDes=document.getElementById("resDes");
const resSal=document.getElementById("resSal");

/* ========= STATE ========= */
let db=[],userNow="",chart;

/* ========= NAV ========= */
function showPage(p){
  document.getElementById("pg-lan").classList.toggle("hidden",p!=="lan");
  document.getElementById("pg-hist").classList.toggle("hidden",p!=="hist");
}

/* ========= LOGIN ========= */
async function fazerLogin(){
  loginError.classList.add("hidden");
  const r=await fetch(`${URL_API}?action=login&user=${encodeURIComponent(userInput.value)}&pass=${encodeURIComponent(passInput.value)}`);
  const j=await r.json();
  if(j.ok){
    userNow=j.usuario;
    telaLogin.classList.add("hidden");
    appContent.classList.remove("hidden");
    initMonths();
    carregar();
  }else loginError.classList.remove("hidden");
}

function logout(){location.reload();}

/* ========= MESES ========= */
function initMonths(){
  monthSelector.innerHTML="";
  const d=new Date(),y=d.getFullYear(),m=d.getMonth();
  for(let i=0;i<12;i++){
    const v=`${y}-${String(i+1).padStart(2,"0")}`;
    monthSelector.innerHTML+=`<button class="btn-month ${i===m?'active':''}" onclick="setMes('${v}',this)">${i+1}</button>`;
  }
  mesFoco.value=`${y}-${String(m+1).padStart(2,"0")}`;
}

function setMes(v,b){
  document.querySelectorAll(".btn-month").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  mesFoco.value=v;
  render();
}

/* ========= DADOS ========= */
async function carregar(){
  const r=await fetch(`${URL_API}?action=listar`);
  const d=await r.json();
  db=d.map(l=>({data:l[2],desc:l[3],valor:+l[4],tipo:l[5],pago:l[6]==="PAGO"}));
  render();
  renderHistorico();
}

function adicionar(){
  db.push({id:Date.now(),data:fData.value,desc:fDesc.value,valor:+fValor.value,tipo:fTipo.value,pago:false,user:userNow});
  salvar();
}

async function salvar(){
  await fetch(URL_API,{method:"POST",body:JSON.stringify(db)});
  render();
  renderHistorico();
}

/* ========= LANÃ‡AMENTOS ========= */
function render(){
  corpoItens.innerHTML="";
  let r=0,d=0;
  db.filter(x=>x.data&&x.data.startsWith(mesFoco.value)).forEach(i=>{
    i.tipo==="Receita"?r+=i.valor:d+=i.valor;
    corpoItens.innerHTML+=`
    <tr>
      <td><input type="checkbox" disabled ${i.pago?'checked':''}></td>
      <td>${i.desc}</td>
      <td class="${i.tipo==='Receita'?'val-receita':'val-despesa'}">R$ ${i.valor.toFixed(2)}</td>
      <td>${i.pago?'<span class="status-pago">PAGO</span>':'<span class="status-pendente">PENDENTE</span>'}</td>
    </tr>`;
  });
  resRec.innerText=`R$ ${r.toFixed(2)}`;
  resDes.innerText=`R$ ${d.toFixed(2)}`;
  resSal.innerText=`R$ ${(r-d).toFixed(2)}`;
}

/* ========= HISTÃ“RICO ========= */
function renderHistorico(){
  const hist={},corpo=document.getElementById("corpoHist");
  corpo.innerHTML="";
  db.forEach(l=>{
    if(!l.data)return;
    const m=l.data.substring(0,7);
    hist[m]=hist[m]||{r:0,d:0};
    l.tipo==="Receita"?hist[m].r+=l.valor:hist[m].d+=l.valor;
  });
  const meses=Object.keys(hist).sort();
  meses.forEach(m=>{
    const s=hist[m].r-hist[m].d;
    corpo.innerHTML+=`
    <tr>
      <td>${m.substring(5,7)}/${m.substring(0,4)}</td>
      <td class="val-receita">R$ ${hist[m].r.toFixed(2)}</td>
      <td class="val-despesa">R$ ${hist[m].d.toFixed(2)}</td>
      <td class="${s>=0?'val-receita':'val-despesa'}">R$ ${s.toFixed(2)}</td>
    </tr>`;
  });
  renderGrafico(hist,meses);
}

function renderGrafico(hist,meses){
  if(chart)chart.destroy();
  chart=new Chart(document.getElementById("chartHist"),{
    type:"line",
    data:{
      labels:meses.map(m=>m.substring(5,7)+"/"+m.substring(0,4)),
      datasets:[
        {label:"Receita",data:meses.map(m=>hist[m].r),borderWidth:3},
        {label:"Despesa",data:meses.map(m=>hist[m].d),borderWidth:3},
        {label:"Saldo",data:meses.map(m=>hist[m].r-hist[m].d),borderWidth:4}
      ]
    },
    options:{plugins:{legend:{position:"bottom"}}}
  });
}
</script>

</body>
</html>
