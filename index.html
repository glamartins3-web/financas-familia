<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#f0f2f5;font-family:'Segoe UI',Tahoma,sans-serif;padding-top:70px}
.hidden{display:none!important}
.nav-top{position:fixed;top:0;width:100%;background:#1a252f;padding:12px;display:flex;justify-content:center;gap:10px;z-index:1000}
.container-box{background:#fff;border-radius:16px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,.08);margin-bottom:20px}
#tela-login{position:fixed;inset:0;background:#1a252f;display:flex;align-items:center;justify-content:center;z-index:9999}
.login-box{background:#fff;padding:30px;border-radius:18px;max-width:360px;width:100%}
.card-resumo{border-radius:16px;padding:18px;color:#fff;text-align:center;font-weight:bold}
.bg-receita{background:linear-gradient(135deg,#2ecc71,#27ae60)}
.bg-despesa{background:linear-gradient(135deg,#ff7675,#e74c3c)}
.bg-saldo{background:linear-gradient(135deg,#6c5ce7,#341f97)}
.val-receita{color:#27ae60;font-weight:bold}
.val-despesa{color:#e74c3c;font-weight:bold}
.status-pago{color:#27ae60;font-weight:bold}
.status-pendente{color:#f39c12;font-weight:bold}
.month-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:8px}
.btn-month{border:1px solid #ddd;border-radius:10px;padding:8px;background:#fff;font-weight:bold}
.btn-month.active{background:#1a252f;color:#fff}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="tela-login">
  <div class="login-box text-center">
    <div style="font-size:3rem">üè¶</div>
    <h4 class="fw-bold mb-3">Bem-vindo</h4>
    <input id="userInput" class="form-control mb-2" placeholder="Usu√°rio">
    <input id="passInput" type="password" class="form-control mb-3" placeholder="Senha">
    <button class="btn btn-dark w-100 fw-bold" onclick="fazerLogin()">ENTRAR</button>
    <div id="loginError" class="text-danger mt-2 small hidden"></div>
  </div>
</div>

<!-- APP -->
<div id="appContent" class="hidden">

<nav class="nav-top">
  <span style="color:#fff;font-weight:bold">
    üë§ Ol√°...<span id="userLogado"></span>
  </span>
  <button class="btn btn-light btn-sm fw-bold" onclick="showPage('lan')">LAN√áAMENTOS</button>
  <button class="btn btn-light btn-sm fw-bold" onclick="showPage('hist')">HIST√ìRICO</button>
  <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
</nav>

<div id="pg-lan" class="container">

  <div class="container-box">
    <div id="monthSelector" class="month-grid"></div>
    <input type="hidden" id="mesFoco">
  </div>

  <div class="row g-2 mb-3">
    <div class="col-4"><div class="card-resumo bg-receita">Receitas<br><span id="resRec">R$0</span></div></div>
    <div class="col-4"><div class="card-resumo bg-despesa">Despesas<br><span id="resDes">R$0</span></div></div>
    <div class="col-4"><div class="card-resumo bg-saldo">Saldo<br><span id="resSal">R$0</span></div></div>
  </div>

  <div class="container-box">
    <div class="row g-2">
      <div class="col-md-2"><input id="fData" type="date" class="form-control"></div>
      <div class="col-md-3"><input id="fDesc" class="form-control" placeholder="Descri√ß√£o"></div>
      <div class="col-md-2"><input id="fValor" type="number" class="form-control" placeholder="Valor"></div>
      <div class="col-md-2">
        <select id="fTipo" class="form-select">
          <option>Receita</option>
          <option>Despesa</option>
        </select>
      </div>
      <div class="col-md-1">
        <input id="fParcelas" type="number" min="1" class="form-control" placeholder="x">
      </div>
      <div class="col-md-2">
        <button class="btn btn-dark w-100" onclick="adicionar()">INCLUIR</button>
      </div>
    </div>
  </div>

  <div class="container-box table-responsive">
    <table class="table table-sm">
      <thead>
        <tr>
          <th>Pago</th>
          <th>Data</th>
          <th>Descri√ß√£o</th>
          <th>Tipo</th>
          <th>Valor</th>
          <th>Status</th>
          <th>Usu√°rio</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="corpoItens"></tbody>
    </table>
  </div>
</div>

<div id="pg-hist" class="container hidden">
  <div class="container-box">
    <canvas id="graficoMensal" height="120"></canvas>
  </div>
</div>

</div>

<!-- TOAST -->
<div id="toast" style="position:fixed;bottom:20px;right:20px;background:#2ecc71;color:#fff;
padding:14px 18px;border-radius:12px;font-weight:bold;display:none;z-index:9999"></div>

<script>
const URL_API="https://script.google.com/macros/s/AKfycbxHjTzh9gF0yfw9LW7EGYTAshfKQJyRV7TCmhmJIQr9pVw4f00bmnZpwbhvtO2e7Fon5Q/exec";

let db=[],userNow="",grafico;

/* LOGIN */
async function fazerLogin(){
  loginError.classList.add("hidden");
  loginError.innerText = "";

  const user = userInput.value.trim();
  const pass = passInput.value.trim();

  if(!user || !pass){
    loginError.innerText = "Informe usu√°rio e senha";
    loginError.classList.remove("hidden");
    return;
  }

  try {
    const resp = await fetch(
      `${URL_API}?action=login&user=${encodeURIComponent(user)}&pass=${encodeURIComponent(pass)}`
    );

    const json = await resp.json();

    if(json.ok){
      userNow = json.usuario;
      localStorage.setItem("usuarioLogado", userNow);

      document.getElementById("userLogado").innerText = userNow;
      telaLogin.classList.add("hidden");
      appContent.classList.remove("hidden");

      initMonths();
      carregar();
    } else {
      loginError.innerText = "Usu√°rio ou senha inv√°lidos";
      loginError.classList.remove("hidden");
    }

  } catch (e) {
    loginError.innerText = "Erro ao conectar ao servidor";
    loginError.classList.remove("hidden");
    console.error(e);
  }
}

function logout(){
  localStorage.clear();
  location.reload();
}

/* MESES */
const MESES=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
function initMonths(){
  const d=new Date();
  const y=d.getFullYear(),m=d.getMonth();
  monthSelector.innerHTML="";
  for(let i=0;i<12;i++){
    const v=`${y}-${String(i+1).padStart(2,"0")}`;
    monthSelector.innerHTML+=`<button class="btn-month ${i===m?'active':''}" onclick="setMes('${v}',this)">${MESES[i]}</button>`;
  }
  mesFoco.value=`${y}-${String(m+1).padStart(2,"0")}`;
}

function setMes(v,b){
  document.querySelectorAll(".btn-month").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  mesFoco.value=v;
  render();
}

/* DADOS */
async function carregar(){
  const r=await fetch(`${URL_API}?action=listar`);
  const d=await r.json();
  db=d.map(l=>({
    id:l[0],groupId:l[1],data:l[2],desc:l[3],
    valor:+l[4],tipo:l[5],status:l[6]||"PENDENTE",user:l[7]||""
  }));
  render();
}

/* PARCELAMENTO */
async function adicionar(){
  const parcelas=Number(fParcelas.value||1);
  const total=parcelas>0?parcelas:1;
  const valor=+fValor.value;
  const base=new Date(fData.value+"T00:00:00");
  const groupId=total>1?Date.now():"";

  for(let p=1;p<=total;p++){
    const dt=new Date(base);
    dt.setMonth(base.getMonth()+p-1);
    const item={
      id:Date.now()+p,
      groupId,
      data:dt.toISOString().slice(0,10),
      desc:total>1?`${fDesc.value} (${p}/${total})`:fDesc.value,
      valor:(valor/total).toFixed(2),
      tipo:fTipo.value,
      user:userNow
    };

    await fetch(URL_API,{method:"POST",body:JSON.stringify({action:"addLancamento",...item})});
    db.push({...item,status:"PENDENTE"});
  }

  render();
  toast("Parcelamento criado");
}

function render(){
  corpoItens.innerHTML="";
  let r=0,d=0;
  const mes=mesFoco.value;

  db.forEach(i=>{
    if(i.data.slice(0,7)!==mes)return;
    i.tipo==="Receita"?r+=+i.valor:d+=+i.valor;
    corpoItens.innerHTML+=`
    <tr>
      <td><input type="checkbox" ${i.status==="PAGO"?"checked":""}></td>
      <td>${i.data}</td>
      <td>${i.desc}</td>
      <td class="${i.tipo==="Receita"?"val-receita":"val-despesa"}">${i.tipo}</td>
      <td>R$ ${(+i.valor).toFixed(2)}</td>
      <td>${i.status}</td>
      <td>${i.user}</td>
      <td>‚Äî</td>
    </tr>`;
  });

  resRec.innerText=`R$ ${r.toFixed(2)}`;
  resDes.innerText=`R$ ${d.toFixed(2)}`;
  resSal.innerText=`R$ ${(r-d).toFixed(2)}`;
}

function toast(m){
  toastEl.innerText=m;
  toastEl.style.display="block";
  setTimeout(()=>toastEl.style.display="none",2500);
}

const toastEl=document.getElementById("toast");

/* AUTO LOGIN */
window.onload=()=>{
  const u=localStorage.getItem("usuarioLogado");
  if(u){
    userNow=u;
    userLogado.innerText=u;
    telaLogin.classList.add("hidden");
    appContent.classList.remove("hidden");
    initMonths();
    carregar();
  }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
