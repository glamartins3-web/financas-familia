<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#f0f2f5;font-family:'Segoe UI',Tahoma,sans-serif;padding-top:70px}
.hidden{display:none!important}
.nav-top{position:fixed;top:0;width:100%;background:#1a252f;padding:12px;display:flex;justify-content:center;gap:10px;z-index:1000}
.container-box{background:#fff;border-radius:16px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,.08);margin-bottom:20px}
#tela-login{position:fixed;inset:0;background:#1a252f;display:flex;align-items:center;justify-content:center;z-index:9999}
.login-box{background:#fff;padding:30px;border-radius:18px;max-width:360px;width:100%}
.card-resumo{border-radius:16px;padding:18px;color:#fff;text-align:center;font-weight:bold}
.bg-receita{background:linear-gradient(135deg,#2ecc71,#27ae60)}
.bg-despesa{background:linear-gradient(135deg,#ff7675,#e74c3c)}
.bg-saldo{background:linear-gradient(135deg,#6c5ce7,#341f97)}
.val-receita{color:#27ae60;font-weight:bold}
.val-despesa{color:#e74c3c;font-weight:bold}
.status-pago{color:#27ae60;font-weight:bold}
.status-pendente{color:#f39c12;font-weight:bold}
.month-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:8px}
.btn-month{border:1px solid #ddd;border-radius:10px;padding:8px;background:#fff;font-weight:bold}
.btn-month.active{background:#1a252f;color:#fff}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="tela-login">
  <div class="login-box text-center">
    <div style="font-size:3rem">üè¶</div>
    <h4 class="fw-bold mb-3">Bem-vindo</h4>
    <input id="userInput" class="form-control mb-2" placeholder="Usu√°rio">
    <input id="passInput" type="password" class="form-control mb-3" placeholder="Senha">
    <button class="btn btn-dark w-100 fw-bold" onclick="fazerLogin()">ENTRAR</button>
    <div id="loginError" class="text-danger mt-2 small hidden">‚ùå Login inv√°lido</div>
  </div>
</div>

<!-- APP -->
<div id="appContent" class="hidden">

<nav class="nav-top">
  <span style="color:#fff;font-weight:bold">üë§ Ol√° ... <span id="userLogado"></span></span>
  <button class="btn btn-light btn-sm" onclick="showPage('lan')">LAN√áAMENTOS</button>
  <button class="btn btn-light btn-sm" onclick="showPage('hist')">HIST√ìRICO</button>
  <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
</nav>

<div id="pg-lan" class="container">

  <div class="container-box">
    <div id="monthSelector" class="month-grid"></div>
    <input type="hidden" id="mesFoco">
  </div>

  <div class="row g-2 mb-3">
    <div class="col-4"><div class="card-resumo bg-receita">Receitas<br><span id="resRec">0</span></div></div>
    <div class="col-4"><div class="card-resumo bg-despesa">Despesas<br><span id="resDes">0</span></div></div>
    <div class="col-4"><div class="card-resumo bg-saldo">Saldo<br><span id="resSal">0</span></div></div>
  </div>

  <div class="container-box">
    <div class="row g-2">
      <div class="col-md-2"><input id="fData" type="date" class="form-control"></div>
      <div class="col-md-4"><input id="fDesc" class="form-control" placeholder="Descri√ß√£o"></div>
      <div class="col-md-2"><input id="fValor" type="number" class="form-control" placeholder="Valor"></div>
      <div class="col-md-2"><input id="fParcelas" type="number" class="form-control" placeholder="Parcelas" min="1"></div>
      <div class="col-md-2">
        <select id="fTipo" class="form-select">
          <option>Receita</option>
          <option>Despesa</option>
        </select>
      </div>
      <button class="btn btn-dark mt-2" onclick="adicionar()">INCLUIR</button>
    </div>
  </div>

  <div class="container-box table-responsive">
    <table class="table table-sm">
      <thead>
        <tr>
          <th>Pago</th>
          <th>Data</th>
          <th>Descri√ß√£o</th>
          <th>Valor</th>
          <th>Status</th>
          <th>Usu√°rio</th>
        </tr>
      </thead>
      <tbody id="corpoItens"></tbody>
    </table>
  </div>
</div>

</div>

<script>
const URL_API="https://script.google.com/macros/s/AKfycbxHjTzh9gF0yfw9LW7EGYTAshfKQJyRV7TCmhmJIQr9pVw4f00bmnZpwbhvtO2e7Fon5Q/exec";

/* DOM */
const userInput=document.getElementById("userInput");
const passInput=document.getElementById("passInput");
const telaLogin=document.getElementById("tela-login");
const appContent=document.getElementById("appContent");
const loginError=document.getElementById("loginError");

const fData=document.getElementById("fData");
const fDesc=document.getElementById("fDesc");
const fValor=document.getElementById("fValor");
const fParcelas=document.getElementById("fParcelas");
const fTipo=document.getElementById("fTipo");

const corpoItens=document.getElementById("corpoItens");
const resRec=document.getElementById("resRec");
const resDes=document.getElementById("resDes");
const resSal=document.getElementById("resSal");

let db=[],userNow="";

/* LOGIN */
async function fazerLogin(){
  loginError.classList.add("hidden");
  const r=await fetch(`${URL_API}?action=login&user=${userInput.value}&pass=${passInput.value}`);
  const j=await r.json();
  if(j.ok){
    userNow=j.usuario;
    localStorage.setItem("usuarioLogado",userNow);
    telaLogin.classList.add("hidden");
    appContent.classList.remove("hidden");
    document.getElementById("userLogado").innerText=userNow;
    carregar();
  }else{
    loginError.classList.remove("hidden");
  }
}

function logout(){
  localStorage.clear();
  location.reload();
}

/* DADOS */
async function carregar(){
  const r=await fetch(`${URL_API}?action=listar`);
  const d=await r.json();
  db=d.map(l=>({
    id:l[0],data:l[2],desc:l[3],valor:+l[4],tipo:l[5],status:l[6],user:l[7]
  }));
  render();
}

async function adicionar(){
  const parcelas=Math.max(1,Number(fParcelas.value||1));
  const valorParcela=(+fValor.value/parcelas).toFixed(2);
  const base=new Date(fData.value+"T00:00:00");
  const groupId=parcelas>1?Date.now():"";

  for(let i=1;i<=parcelas;i++){
    const d=new Date(base);
    d.setMonth(d.getMonth()+i-1);
    const item={
      id:Date.now()+i,
      groupId,
      data:d.toISOString().slice(0,10),
      desc:parcelas>1?`${fDesc.value} (${i}/${parcelas})`:fDesc.value,
      valor:+valorParcela,
      tipo:fTipo.value,
      user:userNow
    };
    await fetch(URL_API,{method:"POST",body:JSON.stringify({action:"addLancamento",...item})});
    db.push({...item,status:"PENDENTE"});
  }
  render();
}

function render(){
  corpoItens.innerHTML="";
  let r=0,d=0;
  db.forEach(i=>{
    i.tipo==="Receita"?r+=i.valor:d+=i.valor;
    corpoItens.innerHTML+=`
      <tr>
        <td><input type="checkbox"></td>
        <td>${i.data}</td>
        <td>${i.desc}</td>
        <td>${i.valor.toFixed(2)}</td>
        <td>${i.status}</td>
        <td>${i.user}</td>
      </tr>`;
  });
  resRec.innerText=r.toFixed(2);
  resDes.innerText=d.toFixed(2);
  resSal.innerText=(r-d).toFixed(2);
}

window.onload=()=>{
  const u=localStorage.getItem("usuarioLogado");
  if(u){
    userNow=u;
    telaLogin.classList.add("hidden");
    appContent.classList.remove("hidden");
    document.getElementById("userLogado").innerText=u;
    carregar();
  }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
