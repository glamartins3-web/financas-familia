<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#f0f2f5;font-family:'Segoe UI',Tahoma,sans-serif;padding-top:70px}
.hidden{display:none!important}
.nav-top{position:fixed;top:0;width:100%;background:#1a252f;padding:12px;display:flex;justify-content:center;gap:10px;z-index:1000}
.container-box{background:#fff;border-radius:16px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,.08);margin-bottom:20px}
#tela-login{position:fixed;inset:0;background:#1a252f;display:flex;align-items:center;justify-content:center;z-index:9999}
.login-box{background:#fff;padding:30px;border-radius:18px;max-width:360px;width:100%}
.card-resumo{border-radius:16px;padding:18px;color:#fff;text-align:center;font-weight:bold}
.bg-receita{background:linear-gradient(135deg,#2ecc71,#27ae60)}
.bg-despesa{background:linear-gradient(135deg,#ff7675,#e74c3c)}
.bg-saldo{background:linear-gradient(135deg,#6c5ce7,#341f97)}
.val-receita{color:#27ae60;font-weight:bold}
.val-despesa{color:#e74c3c;font-weight:bold}
.status-pago{color:#27ae60;font-weight:bold}
.status-pendente{color:#f39c12;font-weight:bold}
.month-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:8px}
.btn-month{border:1px solid #ddd;border-radius:10px;padding:8px;background:#fff;font-weight:bold}
.btn-month.active{background:#1a252f;color:#fff}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="tela-login">
  <div class="login-box text-center">
    <div class="mb-2" style="font-size: 3rem;">üè¶</div>
    <h4 class="fw-bold mb-3">Bem-vindo</h4>
    <input id="userInput" class="form-control mb-2" placeholder="Usu√°rio">
    <input id="passInput" type="password" class="form-control mb-3" placeholder="Senha">
    <button class="btn btn-dark w-100 fw-bold" onclick="fazerLogin()">ENTRAR NO SISTEMA</button>
    <div id="loginError" class="text-danger mt-2 small hidden">‚ùå Dados de acesso inv√°lidos</div>
  </div>
</div>

<!-- APP -->
<div id="appContent" class="hidden">

<nav class="nav-top">
  <span style="color:#fff;font-weight:bold">
    üë§ Ol√° --- <span id="userLogado"></span>
  </span>

  <button class="btn btn-light btn-sm fw-bold" onclick="showPage('lan')">üí∏ LAN√áAMENTOS</button>
  <button class="btn btn-light btn-sm fw-bold" onclick="showPage('hist')">üìä HIST√ìRICO</button>
  <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
</nav>

<!-- LAN√áAMENTOS -->
<div id="pg-lan" class="container">

  <div class="container-box">
    <div id="monthSelector" class="month-grid"></div>
    <input type="hidden" id="mesFoco">
  </div>

  <div class="row g-2 mb-3">
    <div class="col-4"><div class="card-resumo bg-receita">Receitas<br><span id="resRec">R$0</span></div></div>
    <div class="col-4"><div class="card-resumo bg-despesa">Despesas<br><span id="resDes">R$0</span></div></div>
    <div class="col-4"><div class="card-resumo bg-saldo">Saldo<br><span id="resSal">R$0</span></div></div>
  </div>
  
  <!-- NOVOS CAMPOS NO FORMUL√ÅRIO -->
<div class="col-md-2">
  <input id="fParcelas" type="number" class="form-control" placeholder="Parcelas" min="1">
</div> 

   <!-- RECORR√äNCIA FIXA (mensal autom√°tica) -->
  <div class="col-md-2">
  <select id="fRecorrente" class="form-select">
    <option value="N">√önica</option>
    <option value="S">Recorrente</option>
  </select>
</div>
  
  <div class="container-box">
    <div class="row g-2">
      <div class="col-md-3"><input id="fData" type="date" class="form-control"></div>
      <div class="col-md-4"><input id="fDesc" class="form-control" placeholder="Descri√ß√£o"></div>
      <div class="col-md-2"><input id="fValor" type="number" class="form-control" placeholder="Valor"></div>
      <div class="col-md-3">
        <select id="fTipo" class="form-select">
          <option>Receita</option>
          <option>Despesa</option>
        </select>
      </div>

      <!----- üí∞ Sal√°rio / Adiantamento ---->
      <div class="d-flex gap-2 mt-2">
<button
  type="button"
  class="btn btn-outline-success w-50"
  onclick="abrirSalario()">
  üí∞ Sal√°rio / Adiantamento
</button>
        <button class="btn btn-dark w-100 fw-bold mt-2" onclick="adicionar()">INCLUIR</button>
      </div>
    </div>
  </div>

  <div class="container-box mb-2">
  <strong>Detalhamento Financeiro</strong><br>
  <span class="status-pago">
    PAGO: R$ <span id="totalPago">0,00</span>
  </span>
  |
  <span class="status-pendente">
    PENDENTE: R$ <span id="totalPendente">0,00</span>
  </span>
</div>

  
  <div class="container-box table-responsive">
    <table class="table table-sm table-hover">
<thead>
  <tr>
    <th>Pago</th>
    <th>Data</th>
    <th>Descri√ß√£o</th>
    <th>Tipo</th> <!-- üëà NOVA -->
    <th>Valor</th>
    <th>Status</th>
    <th>Usu√°rio</th>
    <th>A√ß√µes</th>
  </tr>
</thead>

      <tbody id="corpoItens"></tbody>
    </table>
  </div>
</div>

  
  
<!-- HIST√ìRICO -->
<div id="pg-hist" class="container hidden">

  <div class="container-box">
    <h5 class="fw-bold mb-3">Hist√≥rico Mensal</h5>
    <div style="height:300px">
      <canvas id="chartHist"></canvas>
    </div>
  </div>
  
<div class="container-box">
  <h6 class="fw-bold mb-2">Evolu√ß√£o Mensal</h6>
  <canvas id="graficoMensal" height="120"></canvas>
</div>
  
  <div class="container-box table-responsive">
    <table class="table table-hover">
      <thead class="table-dark">
        <tr>
          <th>M√™s/Ano</th>
          <th>Receita</th>
          <th>Despesa</th>
          <th>Saldo</th>
        </tr>
      </thead>
      <tbody id="corpoHist"></tbody>
    </table>
  </div>
</div>

</div>

<script>
/* ========= CONFIG ========= */
const URL_API="https://script.google.com/macros/s/AKfycbxHjTzh9gF0yfw9LW7EGYTAshfKQJyRV7TCmhmJIQr9pVw4f00bmnZpwbhvtO2e7Fon5Q/exec";

/* ========= DOM ========= */
const userInput=document.getElementById("userInput");
const passInput=document.getElementById("passInput");
const telaLogin=document.getElementById("tela-login");
const appContent=document.getElementById("appContent");
const loginError=document.getElementById("loginError");

const monthSelector=document.getElementById("monthSelector");
const mesFoco=document.getElementById("mesFoco");

const fData=document.getElementById("fData");
const fDesc=document.getElementById("fDesc");
const fValor=document.getElementById("fValor");
const fTipo=document.getElementById("fTipo");

const corpoItens=document.getElementById("corpoItens");
const resRec=document.getElementById("resRec");
const resDes=document.getElementById("resDes");
const resSal=document.getElementById("resSal");

const totalPago = document.getElementById("totalPago");
const totalPendente = document.getElementById("totalPendente");

/* ========= STATE ========= */
let db=[],userNow="",chart;

/* ========= NAV ========= */
function showPage(p){
  document.getElementById("pg-lan").classList.toggle("hidden",p!=="lan");
  document.getElementById("pg-hist").classList.toggle("hidden",p!=="hist");
}

/* ========= LOGIN ========= */
async function fazerLogin(){
  loginError.classList.add("hidden");

  const r = await fetch(
    `${URL_API}?action=login&user=${encodeURIComponent(userInput.value)}&pass=${encodeURIComponent(passInput.value)}`
  );

  const j = await r.json();

  if(j.ok){
    userNow = j.usuario;

    // üîê SALVA SESS√ÉO
    localStorage.setItem("usuarioLogado", userNow);

    telaLogin.classList.add("hidden");
    appContent.classList.remove("hidden");

    document.getElementById("userLogado").innerText = userNow;

    initMonths();
    carregar();
  } else {
    loginError.classList.remove("hidden");
  }
}


function logout(){
  localStorage.removeItem("usuarioLogado");
  location.reload();
}


/* ========= MESES ========= */
const MESES_ABREV = [
  "Jan","Fev","Mar","Abr","Mai","Jun",
  "Jul","Ago","Set","Out","Nov","Dez"
];
  
function initMonths(){
  monthSelector.innerHTML="";
  const d=new Date(),y=d.getFullYear(),m=d.getMonth();
for(let i=0;i<12;i++){
  const v = `${y}-${String(i+1).padStart(2,"0")}`;

  monthSelector.innerHTML += `
    <button class="btn-month ${i===m?'active':''}"
      onclick="setMes('${v}',this)">
      ${MESES_ABREV[i]}
    </button>`;
}

  mesFoco.value=`${y}-${String(m+1).padStart(2,"0")}`;
}

function setMes(v,b){
  document.querySelectorAll(".btn-month").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  mesFoco.value=v;
  render();
}
/*--Criar uma fun√ß√£o de formata√ß√£o de data-*/
  function formatarDataBR(data) {
  if (!data) return "";

  // Se j√° for Date
  if (data instanceof Date) {
    const d = String(data.getDate()).padStart(2, "0");
    const m = String(data.getMonth() + 1).padStart(2, "0");
    const a = String(data.getFullYear()).slice(2);
    return `${d}/${m}/${a}`;
  }

  // Se vier como string ISO ou ISO com hora
  if (typeof data === "string") {
    // pega s√≥ a parte da data (YYYY-MM-DD)
    const iso = data.split("T")[0];
    const [y, m, d] = iso.split("-");
    if (!y || !m || !d) return data;
    return `${d}/${m}/${y.slice(2)}`;
  }

  return data;
}
  
/* ========= DADOS ========= */
async function carregar(){
  const r = await fetch(`${URL_API}?action=listar`);
  const d = await r.json();

  db = d.map(l => ({
  id: l[0],
  data: l[2],
  desc: l[3],
  valor: +l[4],
  tipo: l[5],
  status: l[6] || "PENDENTE", // üî• √öNICO CONTROLE
  user: l[7] || ""
}));


  render();
  renderHistorico();
}

function limparFormulario(){
  fData.value = "";
  fDesc.value = "";
  fValor.value = "";
  fTipo.value = "Receita";

  const fParcelas = document.getElementById("fParcelas");
  if(fParcelas) fParcelas.value = "";

  const fRec = document.getElementById("fRecorrente");
  if(fRec) fRec.value = "N";
}


// Ajuste sua fun√ß√£o adicionar //
async function adicionar(){
  document.querySelectorAll(".is-invalid")
    .forEach(e => e.classList.remove("is-invalid"));

  let erro = false;

  if(!fData.value){ fData.classList.add("is-invalid"); erro=true; }
  if(!fDesc.value || fDesc.value.length < 3){ fDesc.classList.add("is-invalid"); erro=true; }
  if(!fValor.value || Number(fValor.value) <= 0){ fValor.classList.add("is-invalid"); erro=true; }
  if(!fTipo.value){ fTipo.classList.add("is-invalid"); erro=true; }

  if(erro){
    mostrarToast("‚ö†Ô∏è Preencha todos os campos corretamente");
    return;
  }

  const item = {
    id: editandoId || Date.now(),
    data: fData.value,
    desc: fDesc.value,
    valor: +fValor.value,
    tipo: fTipo.value,
    user: userNow
  };

  const action = editandoId ? "updateLancamento" : "addLancamento";

  // üîê PRIMEIRO grava no GAS
  const resp = await fetch(URL_API,{
    method:"POST",
    body: JSON.stringify({
      action,
      ...item
    })
  });

  const json = await resp.json();
  if(!json.ok){
    mostrarToast("‚ùå Erro ao salvar");
    return;
  }

  // üß† AGORA sincroniza o estado local
  if(editandoId){
    const idx = db.findIndex(x => String(x.id) === String(editandoId));
    if(idx > -1){
      db[idx] = { ...db[idx], ...item };
    }
    editandoId = null;
  }else{
    db.push({ ...item, status:"PENDENTE" });
  }

  render();
  renderHistorico();
  limparFormulario();
  mostrarToast("‚úÖ Registro salvo");
}


async function salvar(){
  await fetch(URL_API,{
    method:"POST",
    body:JSON.stringify(db)
  });

  render();
  renderHistorico();

  mostrarToast("‚úÖ Salvo com sucesso");
}


  /*-------FUN√á√ÉO DO TOAST (OBRIGAT√ìRIO) ------------*/
function mostrarToast(msg = "‚úÖ Salvo com sucesso") {
  const toast = document.getElementById("toast");
  if (!toast) return;

  toast.innerText = msg;
  toast.style.display = "block";

  setTimeout(() => {
    toast.style.display = "none";
  }, 2500);
}
  
/* ========= Caixa de Sele√ß√£o pago ========= */
async function togglePago(id) {
  const item = db.find(x => String(x.id) === String(id));
  if (!item) return;

  const novoStatus =
    item.status === "PAGO" ? "PENDENTE" : "PAGO";

  item.status = novoStatus;

  await fetch(URL_API, {
    method: "POST",
    body: JSON.stringify({
      action: "updatePago",
      id: item.id,
      status: novoStatus
    })
  });

  render();
}

/* ========= LAN√áAMENTOS ========= */
function render(){
function render(){
  corpoItens.innerHTML = "";

  let r = 0;
  let d = 0;
  let totalPagoMes = 0;
  let totalPendenteMes = 0;

  const mesAtual = mesFoco.value;

  db.forEach(i => {
    if (!i.data) return;

    const mesItem = i.data.slice(0,7);

    if (mesItem !== mesAtual) return;


    const mesItem = i.data.slice(0,7);
    const mesInicio = i.inicio ? i.inicio.slice(0,7) : mesItem;

    const aparece =
      i.recorrente
        ? mesAtual >= mesInicio
        : mesItem === mesAtual;

    if(!aparece) return;

    i.tipo==="Receita" ? r+=i.valor : d+=i.valor;
    
    // Receita / Despesa
    if (i.tipo === "Receita") {
      r += i.valor;
    } else {
      d += i.valor;
    }

    // üî• DETALHAMENTO FINANCEIRO
    if (i.status === "PAGO") {
      totalPagoMes += i.valor;
    } else {
      totalPendenteMes += i.valor;
    }

corpoItens.innerHTML += `
<tr>

  <!-- Pago -->
  <td>
    <input type="checkbox"
      ${i.status === "PAGO" ? "checked" : ""}
      onclick="togglePago('${i.id}')">
  </td>

  <!-- Data -->
  <td>${formatarDataBR(i.data)}</td>

  <!-- Descri√ß√£o -->
<td>
  ${i.desc === "Sal√°rio" || i.desc === "Adiantamento"
    ? "üí∞ " + i.desc
    : i.desc}
</td>

<!-- Tipo -->
<td class="${i.tipo === 'Receita' ? 'val-receita' : 'val-despesa'}">
  ${i.tipo === 'Receita' ? 'üí∞ Receita' : 'üí∏ Despesa'}
</td>


  <!-- Valor -->
  <td class="${i.tipo==='Receita'?'val-receita':'val-despesa'}">
    R$ ${i.valor.toFixed(2)}
  </td>

  <!-- Status -->
  <td>
    ${i.status === "PAGO"
      ? '<span class="status-pago">PAGO</span>'
      : '<span class="status-pendente">PENDENTE</span>'}
  </td>

  <!-- üë§ USU√ÅRIO -->
  <td>${i.user || "-"}</td>

  <!-- ‚öôÔ∏è A√á√ïES -->
  <td>
    <button class="btn btn-sm btn-outline-primary"
      onclick="editar('${i.id}')">‚úèÔ∏è Editar</button>

    <button class="btn btn-sm btn-outline-danger"
      onclick="excluir('${i.id}')">üóëÔ∏è Excluir</button>
  </td>

</tr>`;

totalPago.innerText = totalPagoMes.toFixed(2);
totalPendente.innerText = totalPendenteMes.toFixed(2);

  });

  resRec.innerText = `R$ ${r.toFixed(2)}`;
  resDes.innerText = `R$ ${d.toFixed(2)}`;
  resSal.innerText = `R$ ${(r - d).toFixed(2)}`;

  totalPago.innerText = totalPagoMes.toFixed(2);
  totalPendente.innerText = totalPendenteMes.toFixed(2);
}


async function excluir(id){
  if(!confirm("Excluir este lan√ßamento?")) return;

  await fetch(URL_API,{
    method:"POST",
    body: JSON.stringify({
      action:"deleteLancamento",
      id:id
    })
  });

  db = db.filter(x => String(x.id) !== String(id));

  render();
  renderHistorico();
  mostrarToast("üóëÔ∏è Exclu√≠do");
}

let editandoId = null;
  
function editar(id){
  const i = db.find(x => String(x.id) === String(id));
  if(!i) return;

  editandoId = i.id; // üîë guarda o ID

  fData.value  = i.data;
  fDesc.value  = i.desc;
  fValor.value = i.valor;
  fTipo.value  = i.tipo;

  mostrarToast("‚úèÔ∏è Editando lan√ßamento");
}



/* ========= HIST√ìRICO ========= */
function renderHistorico(){
  const hist={},corpo=document.getElementById("corpoHist");
  corpo.innerHTML="";
  db.forEach(l=>{
    if(!l.data)return;
    const m=l.data.substring(0,7);
    hist[m]=hist[m]||{r:0,d:0};
    l.tipo==="Receita"?hist[m].r+=l.valor:hist[m].d+=l.valor;
  });
  const meses=Object.keys(hist).sort();
  meses.forEach(m=>{
    const s=hist[m].r-hist[m].d;
    corpo.innerHTML+=`
    <tr>
      <td>${m.substring(5,7)}/${m.substring(0,4)}</td>
      <td class="val-receita">R$ ${hist[m].r.toFixed(2)}</td>
      <td class="val-despesa">R$ ${hist[m].d.toFixed(2)}</td>
      <td class="${s>=0?'val-receita':'val-despesa'}">R$ ${s.toFixed(2)}</td>
    </tr>`;
  });
  renderGrafico(hist,meses);
}

let grafico;

function renderGrafico(){
  const mapa = {};

  db.forEach(i=>{
    if(!i.data) return;
    const mes = i.data.slice(0,7);
    if(!mapa[mes]) mapa[mes]={r:0,d:0};
    i.tipo==="Receita"
      ? mapa[mes].r+=i.valor
      : mapa[mes].d+=i.valor;
  });

  if (i.status === "PAGO") {
  totalPagoMes += i.valor;
} else {
  totalPendenteMes += i.valor;
}

  const meses = Object.keys(mapa).sort();
  const receitas = meses.map(m=>mapa[m].r);
  const despesas = meses.map(m=>mapa[m].d);
  const saldo = meses.map((m,i)=>receitas[i]-despesas[i]);

  const ctx = document.getElementById("graficoMensal").getContext("2d");
  if(grafico) grafico.destroy();

  grafico = new Chart(ctx,{
  type: "bar",
  data: {
    labels: meses,
    datasets: [
     {
  label: "Receitas",
  data: receitas,
  backgroundColor: "#27ae60",
  borderRadius: 6
},
      {
        label: "Despesas",
        data: despesas,
        backgroundColor: "#e74c3c"
      },
      {
        label: "Saldo",
        data: saldo,
        backgroundColor: "#6c5ce7"
      }
    ]
  },
  options: {
    responsive: true,
    plugins: {
      legend: {
        position: "bottom"
      }
    },
    scales: {
      y: {
        beginAtZero: true
      }
    }
  }
});

}

function abrirSalario(){
  new bootstrap.Modal(document.getElementById("modalSalario")).show();
}

  /*---fun√ß√µes do sal√°rio---*/
async function salvarSalario(){
  const s05 = Number(document.getElementById("sal05").value || 0);
  const s20 = Number(document.getElementById("sal20").value || 0);

  const hoje = new Date();
  const mes = hoje.toISOString().slice(0,7);

  const registros = [];

  if(s05 > 0){
    registros.push({
  id: Date.now()+1,
  data: `${mes}-05`,
  desc: "Sal√°rio",
  valor: s05,
  tipo: "Receita",
  recorrente: true,
  inicio: mes
});

  }

  if(s20 > 0){
    registros.push({
  id: Date.now()+2,
  data: `${mes}-20`,
  desc: "Adiantamento",
  valor: s20,
  tipo: "Receita",
  recorrente: true,
  inicio: mes
});

  }

  for(const r of registros){
    r.user = userNow;
    db.push({...r,status:"PENDENTE"});

    await fetch(URL_API,{
      method:"POST",
      body:JSON.stringify({
        action:"addLancamento",
        ...r
      })
    });
  }

  render();
  renderHistorico();
  mostrarToast("üí∞ Sal√°rio registrado");
}

  
function showToast(msg = "Salvo com sucesso") {
  const t = document.getElementById("toast");
  t.innerText = "‚úÖ " + msg;
  t.style.display = "block";
  t.style.opacity = "1";

  setTimeout(() => {
    t.style.opacity = "0";
    setTimeout(() => t.style.display = "none", 400);
  }, 3000);
}

  /*-----RESTAURAR LOGIN AO ABRIR A P√ÅGINA-----*/
window.onload = () => {
  const u = localStorage.getItem("usuarioLogado");
  if (u) {
    userNow = u;
    telaLogin.classList.add("hidden");
    appContent.classList.remove("hidden");
    document.getElementById("userLogado").innerText = u;
    initMonths();
    carregar();
  }
};


  
</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
<div class="modal fade" id="modalSalario">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üí∞ Sal√°rio</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <label>Sal√°rio (dia 05)</label>
        <input id="sal05" type="number" class="form-control mb-2">

        <label>Adiantamento (dia 20)</label>
        <input id="sal20" type="number" class="form-control">
      </div>

      <div class="modal-footer">
        <button class="btn btn-success w-100" onclick="salvarSalario()">
          Registrar
        </button>
      </div>
    </div>
  </div>
</div>

  
<!-- TOAST -->
<div id="toast" style="
  position:fixed;
  bottom:20px;
  right:20px;
  background:#2ecc71;
  color:#fff;
  padding:14px 18px;
  border-radius:12px;
  font-weight:bold;
  box-shadow:0 6px 18px rgba(0,0,0,.2);
  display:none;
  z-index:99999;
">
  ‚úÖ Salvo com sucesso
</div>
 
</body>
</html>
