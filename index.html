<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#f0f2f5;font-family:'Segoe UI',Tahoma,sans-serif;padding-top:70px}
.hidden{display:none!important}
.nav-top{position:fixed;top:0;width:100%;background:#1a252f;padding:12px;display:flex;justify-content:center;gap:10px;z-index:1000}
.container-box{background:#fff;border-radius:16px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,.08);margin-bottom:20px}
#tela-login{position:fixed;inset:0;background:#1a252f;display:flex;align-items:center;justify-content:center;z-index:9999}
.login-box{background:#fff;padding:30px;border-radius:18px;max-width:360px;width:100%}
.card-resumo{border-radius:16px;padding:18px;color:#fff;text-align:center;font-weight:bold}
.bg-receita{background:linear-gradient(135deg,#2ecc71,#27ae60)}
.bg-despesa{background:linear-gradient(135deg,#ff7675,#e74c3c)}
.bg-saldo{background:linear-gradient(135deg,#6c5ce7,#341f97)}
.val-receita{color:#27ae60;font-weight:bold}
.val-despesa{color:#e74c3c;font-weight:bold}
.status-pago{color:#27ae60;font-weight:bold}
.status-pendente{color:#f39c12;font-weight:bold}
.month-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:8px}
.btn-month{border:1px solid #ddd;border-radius:10px;padding:8px;background:#fff;font-weight:bold}
.btn-month.active{background:#1a252f;color:#fff}
</style>
</head>

<body>

<!-- LOGIN (inalterado) -->
<div id="tela-login">
  <div class="login-box text-center">
    <div class="mb-2" style="font-size: 3rem;">üè¶</div>
    <h4 class="fw-bold mb-3">Bem-vindo</h4>
    <input id="userInput" class="form-control mb-2" placeholder="Usu√°rio">
    <input id="passInput" type="password" class="form-control mb-3" placeholder="Senha">
    <button class="btn btn-dark w-100 fw-bold" onclick="fazerLogin()">ENTRAR NO SISTEMA</button>
    <div id="loginError" class="text-danger mt-2 small hidden">‚ùå Dados de acesso inv√°lidos</div>
  </div>
</div>

<div id="appContent" class="hidden">

<nav class="nav-top">
  <span style="color:#fff;font-weight:bold">
    üë§ <span id="userLogado"></span>
  </span>
  <button class="btn btn-light btn-sm fw-bold" onclick="showPage('lan')">üí∏ LAN√áAMENTOS</button>
  <button class="btn btn-light btn-sm fw-bold" onclick="showPage('hist')">üìä HIST√ìRICO</button>
  <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
</nav>

<div id="pg-lan" class="container">

  <div class="container-box">
    <div id="monthSelector" class="month-grid"></div>
    <input type="hidden" id="mesFoco">
  </div>

  <!-- CAMPOS -->
  <div class="row g-2 mb-3">
    <div class="col-md-2">
      <input id="fParcelas" type="number" class="form-control" placeholder="Parcelas" min="1">
    </div>
  </div>

  <div class="container-box">
    <div class="row g-2">
      <div class="col-md-3"><input id="fData" type="date" class="form-control"></div>
      <div class="col-md-4"><input id="fDesc" class="form-control" placeholder="Descri√ß√£o"></div>
      <div class="col-md-2"><input id="fValor" type="number" class="form-control" placeholder="Valor"></div>
      <div class="col-md-3">
        <select id="fTipo" class="form-select">
          <option>Receita</option>
          <option>Despesa</option>
        </select>
      </div>

      <div class="d-flex gap-2 mt-2">
        <button class="btn btn-dark w-100 fw-bold" onclick="adicionar()">INCLUIR</button>
      </div>
    </div>
  </div>

  <div class="container-box table-responsive">
    <table class="table table-sm table-hover">
      <thead>
        <tr>
          <th>Pago</th>
          <th>Data</th>
          <th>Descri√ß√£o</th>
          <th>Tipo</th>
          <th>Valor</th>
          <th>Status</th>
          <th>Usu√°rio</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="corpoItens"></tbody>
    </table>
  </div>
</div>

</div>

<script>
const URL_API="https://script.google.com/macros/s/AKfycbxHjTzh9gF0yfw9LW7EGYTAshfKQJyRV7TCmhmJIQr9pVw4f00bmnZpwbhvtO2e7Fon5Q/exec";

/* ========= DOM ========= */
const fParcelas = document.getElementById("fParcelas"); // üîß AJUSTE PARCELAMENTO
const fData=document.getElementById("fData");
const fDesc=document.getElementById("fDesc");
const fValor=document.getElementById("fValor");
const fTipo=document.getElementById("fTipo");
const corpoItens=document.getElementById("corpoItens");

/* ========= STATE ========= */
let db=[],userNow="";

/* ========= DADOS ========= */
async function carregar(){
  const r = await fetch(`${URL_API}?action=listar`);
  const d = await r.json();

  db = d.map(l => ({
    id: l[0],
    groupId: l[1] || "",      // üîß AJUSTE PARCELAMENTO
    data: l[2],
    desc: l[3],
    valor: +l[4],
    tipo: l[5],
    status: l[6] || "PENDENTE",
    user: l[7] || ""
  }));

  render();
}

/* ========= ADICIONAR COM PARCELAMENTO ========= */
async function adicionar(){
  const totalParcelas = Math.max(1, Number(fParcelas.value || 1));
  const valorTotal = Number(fValor.value);
  const valorParcela = +(valorTotal / totalParcelas).toFixed(2);
  const dataBase = new Date(fData.value + "T00:00:00");

  const baseId = Date.now();          // üîß AJUSTE PARCELAMENTO
  const groupId = totalParcelas > 1 ? baseId : "";

  for(let p=1;p<=totalParcelas;p++){
    const d = new Date(dataBase);
    d.setMonth(d.getMonth() + (p-1));

    const item = {
      id: baseId + p,
      groupId,
      data: d.toISOString().slice(0,10),
      desc: totalParcelas > 1
        ? `${fDesc.value} (${p}/${totalParcelas})`
        : fDesc.value,
      valor: valorParcela,
      tipo: fTipo.value,
      user: userNow
    };

    await fetch(URL_API,{
      method:"POST",
      body:JSON.stringify({action:"addLancamento",...item})
    });

    db.push({...item,status:"PENDENTE"});
  }

  render();
  fParcelas.value="";
}

/* ========= RENDER ========= */
function render(){
  corpoItens.innerHTML="";
  db.forEach(i=>{
    corpoItens.innerHTML+=`
<tr>
  <td><input type="checkbox"></td>
  <td>${i.data.split("-").reverse().join("/")}</td>
  <td>${i.groupId ? "üí≥ " : ""}${i.desc}</td>
  <td class="${i.tipo==='Receita'?'val-receita':'val-despesa'}">${i.tipo}</td>
  <td>R$ ${i.valor.toFixed(2)}</td>
  <td>${i.status}</td>
  <td>${i.user}</td>
  <td>‚Äî</td>
</tr>`;
  });
}
</script>

</body>
</html>
