<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- LAYOUT BASE --- */
        body { background: #f0f2f5; font-family: 'Segoe UI', Tahoma, sans-serif; padding-top: 70px; }
        .hidden { display: none !important; }
        .container-box { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 6px 18px rgba(0, 0, 0, .08); margin-bottom: 20px; }

        /* --- LOGIN & NAV --- */
        #tela-login { position: fixed; inset: 0; background: #1a252f; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-box { background: #fff; padding: 30px; border-radius: 18px; max-width: 360px; width: 100%; }
        .nav-top { position: fixed; top: 0; width: 100%; background: #1a252f; padding: 12px; display: flex; justify-content: center; gap: 10px; z-index: 1000; }

        /* --- DASHBOARD / TOP BAR --- */
        .top-bar { display: grid; grid-template-columns: 1.2fr 1fr 1.3fr; gap: 12px; margin-bottom: 14px; }
        .top-card { background: #fff; border-radius: 14px; padding: 12px; box-shadow: 0 4px 14px rgba(0, 0, 0, .08); }
        .top-card h6 { font-size: 0.75rem; font-weight: bold; color: #6c757d; margin-bottom: 6px; }

        /* --- SELE√á√ÉO DE M√äS --- */
        .month-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; }
        .btn-month { padding: 4px; font-size: 0.7rem; border-radius: 8px; border: 1px solid #ddd; background: #fff; }
        .btn-month.active { background: #1a252f; color: #fff; border-color: #1a252f; }

        /* --- RESUMO E STATUS --- */
        .resumo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .resumo-item { border-radius: 10px; padding: 8px; color: #fff; font-size: 0.7rem; text-align: center; font-weight: bold; }
        .resumo-item span { display: block; font-size: 0.8rem; margin-top: 2px; }
        .bg-receita { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .bg-despesa { background: linear-gradient(135deg, #ff7675, #e74c3c); }
        .bg-saldo { background: linear-gradient(135deg, #6c5ce7, #341f97); }
        .status-info { font-size: 0.7rem; margin-bottom: 4px; }
        .progress { height: 10px; background-color: #e0e0e0; }
        .bar-pendente { background-color: #e74c3c !important; color: #fff; font-weight: bold; }

        /* --- TABELAS E CORES --- */
        #corpoItens td { font-size: 0.85rem; }
        .val-receita { color: #27ae60; font-weight: bold; }
        .val-despesa { color: #e74c3c; font-weight: bold; }
        .status-pago { color: #27ae60; font-weight: bold; }
        .status-pendente { color: #f39c12; font-weight: bold; }

        /* --- STATUS DE VENCIMENTO --- */
        .vencida { background: #ffe6e6; color: #c0392b; font-weight: bold; }
        .hoje { background: #fff7cc; color: #f39c12; font-weight: bold; }
        .futura { background: #e8f8f0; color: #27ae60; }

        /* TOAST PERSONALIZADO */
        #toast { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: none; padding: 15px 25px; background: #333; color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        @media (max-width: 768px) {
            .top-bar { grid-template-columns: 1fr; }
            #corpoItens td { font-size: 0.8rem; padding: 6px 4px; }
        }
    </style>
</head>

<body>

    <div id="toast"></div>

    <div id="tela-login">
        <div class="login-box text-center">
            <div class="mb-2" style="font-size: 3rem;">üè¶</div>
            <h4 class="fw-bold mb-3">Bem-vindo</h4>
            <input id="userInput" class="form-control mb-2" placeholder="Usu√°rio">
            <input id="passInput" type="password" class="form-control mb-3" placeholder="Senha">
            <button class="btn btn-dark w-100 fw-bold" onclick="fazerLogin()">ENTRAR NO SISTEMA</button>
            <div id="loginError" class="text-danger mt-2 small hidden"></div>
        </div>
    </div>

    <div id="appContent" class="hidden">

        <nav class="nav-top">
            <span style="color:#fff;font-weight:bold">üë§ <span id="userLogado"></span></span>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
        </nav>

        <div id="pg-menu" class="container hidden">
            <div class="container-box text-center">
                <h5 class="fw-bold mb-3">üìå Menu Principal</h5>
                <p class="text-muted small mb-4">Escolha o que deseja acessar</p>
                <div class="d-grid gap-3 col-10 col-md-6 mx-auto">
                    <button class="btn btn-dark btn-lg" onclick="showPage('lan')">üí∏ Lan√ßamentos</button>
                    <button class="btn btn-secondary btn-lg" onclick="showPage('ass')">üîÅ Assinaturas</button>
                    <button class="btn btn-outline-dark btn-lg" onclick="showPage('hist')">üìä Hist√≥rico</button>
                    <button class="btn btn-outline-danger btn-sm" onclick="logout()">Sair</button>
                </div>
            </div>
        </div>

        <div id="pg-lan" class="container hidden">
            <button class="btn btn-outline-secondary btn-sm mb-2" onclick="showPage('menu')">‚¨Ö Voltar ao Menu</button>

            <div class="top-bar">
                <div class="top-card">
                    <h6>üìÖ M√äS / ANO</h6>
                    <select id="anoSelector" class="form-select form-select-sm mb-2" onchange="setAno(this.value)"></select>
                    <div id="monthSelector" class="month-grid"></div>
                    <input type="hidden" id="mesFoco">
                </div>

                <div class="top-card">
                    <h6>üìä RESUMO</h6>
                    <div class="resumo-grid">
                        <div class="resumo-item bg-receita">Receitas <span id="resRec">R$ 0</span></div>
                        <div class="resumo-item bg-despesa">Despesas <span id="resDes">R$ 0</span></div>
                        <div class="resumo-item bg-saldo">Saldo <span id="resSal">R$ 0</span></div>
                    </div>
                </div>

                <div class="top-card">
                    <h6>üìä STATUS</h6>
                    <!---<div class="status-info">Pagas: <b id="qtdPago">0</b> | Pendentes: <b id="qtdPendente">0</b></div>
                    <div class="progress mb-1">
                        <div id="barDespesaPago" class="progress-bar bg-success" style="width:0%">0%</div>
                    </div>--->
                    <div class="status-info"> Pagas: <b id="qtdPago">0</b> | Pendentes: <b id="qtdPendente">0</b> 
                    | <span class="text-danger fw-bold">Total Pendente: <span id="valPendente">R$ 0,00</span></span>
                    </div>
                    <div class="progress">
                        <div id="barDespesaPendente" class="progress-bar bar-pendente" style="width:0%">0%</div>
                    </div>
                </div>
            </div>

            <div class="container-box p-3">
                <h6 class="fw-bold mb-3 text-secondary">‚ûï Novo Lan√ßamento</h6>
                <div class="row g-2 align-items-end mb-3">
                    <div class="col-md-2">
                        <label class="form-label small">üìÖ Data</label>
                        <input id="fData" type="date" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small">üìù Descri√ß√£o</label>
                        <input id="fDesc" class="form-control form-control-sm" placeholder="Ex: Aluguel, Mercado">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">üí∞ Valor</label>
                        <input id="fValor" type="number" class="form-control form-control-sm" placeholder="0,00">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">üìå Tipo</label>
                        <select id="fTipo" class="form-select form-select-sm">
                            <option>Despesa</option>
                            <option>Receita</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex gap-1">
                        <button class="btn btn-success btn-sm w-50" onclick="abrirSalario()">üí∞</button>
                        <button class="btn btn-dark btn-sm w-50" onclick="adicionar()">‚ûï</button>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="chkRecorrente" onchange="toggleRecorrencia()">
                        <label class="form-check-label small">üîÅ Recorrente mensal</label>
                    </div>
                    <span class="small text-muted">por</span>
                    <input id="qtdRecorrencia" type="number" min="2" value="12" class="form-control form-control-sm" style="width:80px" disabled>
                    <span class="small text-muted">meses</span>
                </div>
            </div>

            <div class="container-box table-responsive">
                <h6 class="fw-bold mb-3 text-secondary">üìã Lan√ßamentos do M√™s</h6>
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Pago</th>
                            <th>Data</th>
                            <th>Descri√ß√£o</th>
                            <th>Tipo</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>Usu√°rio</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="corpoItens"></tbody>
                </table>
            </div>
        </div>

        <div id="pg-hist" class="container hidden">
            <button class="btn btn-outline-secondary btn-sm mb-2" onclick="showPage('menu')">‚¨Ö Voltar ao Menu</button>
            <div class="container-box mb-3">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">üìä Tipo de filtro</label>
                        <select id="histFiltro" class="form-select form-select-sm" onchange="renderHistorico()">
                            <option value="anual">Anual</option>
                            <option value="s1">1¬∫ Semestre</option>
                            <option value="s2">2¬∫ Semestre</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">üìÖ Ano</label>
                        <select id="histAno" class="form-select form-select-sm" onchange="renderHistorico()"></select>
                    </div>
                </div>
            </div>
            <div class="container-box">
                <h6 class="fw-bold mb-2">Evolu√ß√£o Mensal</h6>
                <canvas id="graficoMensal" height="120"></canvas>
            </div>
            <div class="container-box table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>M√™s/Ano</th>
                            <th>Receita</th>
                            <th>Despesa</th>
                            <th>Saldo</th>
                        </tr>
                    </thead>
                    <tbody id="corpoHist"></tbody>
                </table>
            </div>
        </div>

        <div id="pg-ass" class="container hidden">
            <button class="btn btn-outline-secondary btn-sm mb-2" onclick="showPage('menu')">‚¨Ö Voltar ao Menu</button>
            <div class="container-box">
                <h6 class="fw-bold mb-3 text-secondary">‚ûï Nova Assinatura</h6>
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label small">Assinatura</label>
                        <input id="aNome" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">Dia Venc.</label>
                        <input id="aVenc" type="number" min="1" max="31" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">Valor Mensal</label>
                        <input id="aValor" type="number" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">Cart√£o</label>
                        <input id="aCartao" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">Status</label>
                        <select id="aStatus" class="form-select form-select-sm">
                            <option value="Ativo">Ativo</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="col-md-1 d-grid">
                        <button class="btn btn-dark btn-sm mt-4" onclick="addAssinatura()">‚ûï</button>
                    </div>
                </div>
            </div>
            <div class="container-box table-responsive">
                <h6 class="fw-bold mb-3 text-secondary">üìã Assinaturas</h6>
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Assinatura</th>
                            <th>Venc.</th>
                            <th>Mensal</th>
                            <th>Cart√£o</th>
                            <th>12x</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="corpoAss"></tbody>
                    <tfoot>
                        <tr class="fw-bold">
                            <td colspan="2">TOTAL ATIVO</td>
                            <td id="totalAss">R$ 0,00</td>
                            <td colspan="4"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalSalario" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configurar Sal√°rios</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Valor Dia 05</label>
                        <input type="number" id="sal05" class="form-control" placeholder="0.00">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Valor Dia 20</label>
                        <input type="number" id="sal20" class="form-control" placeholder="0.00">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success w-100" onclick="salvarSalario()" data-bs-dismiss="modal">Salvar Sal√°rios</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const URL_API = "https://script.google.com/macros/s/AKfycbxHjTzh9gF0yfw9LW7EGYTAshfKQJyRV7TCmhmJIQr9pVw4f00bmnZpwbhvtO2e7Fon5Q/exec";

        /* --- DOM ELEMENTS --- */
        const userInput = document.getElementById("userInput");
        const passInput = document.getElementById("passInput");
        const telaLogin = document.getElementById("tela-login");
        const appContent = document.getElementById("appContent");
        const loginError = document.getElementById("loginError");
        const monthSelector = document.getElementById("monthSelector");
        const mesFoco = document.getElementById("mesFoco");
        const fData = document.getElementById("fData");
        const fDesc = document.getElementById("fDesc");
        const fValor = document.getElementById("fValor");
        const fTipo = document.getElementById("fTipo");
        const corpoItens = document.getElementById("corpoItens");
        const resRec = document.getElementById("resRec");
        const resDes = document.getElementById("resDes");
        const resSal = document.getElementById("resSal");

        /* --- STATE --- */
        let anoAtual = new Date().getFullYear();
        let db = [], assinaturasDB = [], userNow = "", chart;
        const TEMPO_MAX_LOGIN = 10; // minutos
        const AVISO_EXPIRACAO = 2;  // minutos
        const MESES_ABREV = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];

        /* --- NAVEGA√á√ÉO --- */
        function showPage(pagina) {
            const paginas = ["menu", "lan", "ass", "hist"];
            paginas.forEach(p => {
                const el = document.getElementById("pg-" + p);
                if (el) el.classList.add("hidden");
            });

            const alvo = document.getElementById("pg-" + pagina);
            if (alvo) alvo.classList.remove("hidden");

            const nav = document.querySelector(".nav-top");
            if (nav) {
                pagina === "menu" ? nav.classList.add("hidden") : nav.classList.remove("hidden");
            }
        }

        /* --- LOGIN --- */
        async function fazerLogin() {
            loginError.classList.add("hidden");
            try {
                const r = await fetch(`${URL_API}?action=login&user=${encodeURIComponent(userInput.value)}&pass=${encodeURIComponent(passInput.value)}`);
                const j = await r.json();

                if (j.ok) {
                    userNow = j.usuario;
                    localStorage.setItem("usuarioLogado", userNow);
                    localStorage.setItem("loginTime", Date.now());
                    telaLogin.classList.add("hidden");
                    appContent.classList.remove("hidden");
                    document.getElementById("userLogado").innerText = userNow;
                    showPage("menu");
                    
                    initAnos();
                    initMonths();
                    initHistAnos();
                    carregar();
                    carregarAssinaturas();
                } else {
                    loginError.innerText = "‚ùå Usu√°rio ou senha inv√°lidos";
                    loginError.classList.remove("hidden");
                }
            } catch (e) {
                loginError.innerText = "‚ùå Erro de conex√£o";
                loginError.classList.remove("hidden");
            }
        }

        function logout() {
            localStorage.removeItem("usuarioLogado");
            localStorage.removeItem("loginTime");
            location.reload();
        }

        /* --- CONFIGURA√á√ïES CALEND√ÅRIO --- */
        function initAnos() {
            const sel = document.getElementById("anoSelector");
            if (!sel) return;
            sel.innerHTML = "";
            const anoInicio = 2026;
            const anoFim = new Date().getFullYear() + 2;
            for (let a = anoInicio; a <= anoFim; a++) {
                sel.innerHTML += `<option value="${a}" ${a === anoAtual ? "selected" : ""}>${a}</option>`;
            }
        }

        function initHistAnos() {
            const sel = document.getElementById("histAno");
            if (!sel) return;
            sel.innerHTML = "";
            const aBase = new Date().getFullYear();
            for (let a = aBase - 3; a <= aBase + 1; a++) {
                sel.innerHTML += `<option value="${a}" ${a === aBase ? "selected" : ""}>${a}</option>`;
            }
        }

        function initMonths() {
            monthSelector.innerHTML = "";
            const mesHoje = new Date().getMonth();
            for (let i = 0; i < 12; i++) {
                const v = `${anoAtual}-${String(i + 1).padStart(2, "0")}`;
                monthSelector.innerHTML += `
                    <button class="btn-month ${i === mesHoje ? "active" : ""}" onclick="setMes('${v}', this)">
                        ${MESES_ABREV[i]}
                    </button>`;
            }
            mesFoco.value = `${anoAtual}-${String(mesHoje + 1).padStart(2, "0")}`;
        }

        function setAno(a) { anoAtual = Number(a); initMonths(); render(); }
        function setMes(v, b) {
            document.querySelectorAll(".btn-month").forEach(x => x.classList.remove("active"));
            b.classList.add("active");
            mesFoco.value = v;
            render();
        }

        /* --- UTILIT√ÅRIOS --- */
        function formatarDataBR(data) {
            if (!data) return "";
            const iso = typeof data === "string" ? data.split("T")[0] : data.toISOString().split("T")[0];
            const [y, m, d] = iso.split("-");
            return `${d}/${m}/${y.slice(2)}`;
        }

        function mostrarToast(msg) {
            const t = document.getElementById("toast");
            t.innerText = msg;
            t.style.display = "block";
            setTimeout(() => { t.style.display = "none"; }, 3000);
        }

        /* --- DADOS E RENDERS --- */
        async function carregar() {
            const r = await fetch(`${URL_API}?action=listar`);
            const d = await r.json();
            db = d.map(l => ({
                id: l[0],
                data: (l[2] instanceof Date) ? l[2].toISOString().slice(0, 10) : l[2].split("T")[0],
                desc: l[3],
                valor: Number(l[4]),
                tipo: l[5],
                status: l[6] || "PENDENTE",
                user: l[7] || ""
            }));
            render();
            renderHistorico();
        }

        
function render() {
    corpoItens.innerHTML = "";
    // Adicionamos a vari√°vel dPend para somar os valores
    let rTotal = 0, dTotal = 0, dPago = 0, dPend = 0, qPago = 0, qPend = 0;
    const mesAtual = mesFoco.value;

    // ... (sua l√≥gica de ordena√ß√£o da lista continua igual)

    listaGeral.forEach(i => {
        if (!i.data || i.data.slice(0, 7) !== mesAtual) return;

        if (i.tipo === "Receita") {
            rTotal += i.valor;
        } else {
            dTotal += i.valor;
            if (i.status === "PAGO") {
                dPago += i.valor;
                qPago++;
            } else {
                // SOMA O VALOR DAS DESPESAS PENDENTES
                dPend += i.valor; 
                qPend++;
            }
        }
        
        // ... (sua l√≥gica de criar as linhas <tr> continua igual)
    });

    // ATUALIZA√á√ÉO DOS CAMPOS NA TELA
    document.getElementById("resRec").innerText = `R$ ${rTotal.toFixed(2)}`;
    document.getElementById("resDes").innerText = `R$ ${dTotal.toFixed(2)}`;
    document.getElementById("resSal").innerText = `R$ ${(rTotal - dTotal).toFixed(2)}`;

    // Novos campos de Status
    document.getElementById("qtdPago").innerText = qPago;
    document.getElementById("qtdPendente").innerText = qPend;
    document.getElementById("valPendente").innerText = `R$ ${dPend.toFixed(2)}`; // Exibe o valor em R$

    // Atualiza√ß√£o das barras de progresso
    const percP = dTotal > 0 ? Math.round((dPago / dTotal) * 100) : 0;
    const barP = document.getElementById("barDespesaPago");
    const barD = document.getElementById("barDespesaPendente");
    
    if(barP) { barP.style.width = percP + "%"; barP.innerText = percP + "%"; }
    if(barD) { barD.style.width = (100 - percP) + "%"; barD.innerText = (100 - percP) + "%"; }
}
        /* function render() {
            corpoItens.innerHTML = "";
            let rTotal = 0, dTotal = 0, dPago = 0, dPend = 0, qPago = 0, qPend = 0;
            const mesAtual = mesFoco.value;

            const lista = [...db].sort((a, b) => {
                if (a.tipo === "Receita" && b.tipo !== "Receita") return 1;
                if (a.tipo !== "Receita" && b.tipo === "Receita") return -1;
                return new Date(a.data) - new Date(b.data);
            });

            lista.forEach(i => {
                if (!i.data || i.data.slice(0, 7) !== mesAtual) return;

                i.tipo === "Receita" ? rTotal += i.valor : dTotal += i.valor;
                if (i.tipo === "Despesa") {
                    if (i.status === "PAGO") { dPago += i.valor; qPago++; }
                    else { dPend += i.valor; qPend++; }
                }

                corpoItens.innerHTML += `
                    <tr class="${classeVencimento(i)}">
                        <td><input type="checkbox" ${i.status === "PAGO" ? "checked" : ""} onclick="togglePago('${i.id}')"></td>
                        <td>${formatarDataBR(i.data)}</td>
                        <td>${i.desc}</td>
                        <td class="${i.tipo === 'Receita' ? 'val-receita' : 'val-despesa'}">${i.tipo}</td>
                        <td class="${i.tipo === 'Receita' ? 'val-receita' : 'val-despesa'}">R$ ${i.valor.toFixed(2)}</td>
                        <td><span class="${i.status === 'PAGO' ? 'status-pago' : 'status-pendente'}">${i.status}</span></td>
                        <td>${i.user}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editar('${i.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="excluir('${i.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });

            resRec.innerText = `R$ ${rTotal.toFixed(2)}`;
            resDes.innerText = `R$ ${dTotal.toFixed(2)}`;
            resSal.innerText = `R$ ${(rTotal - dTotal).toFixed(2)}`;

            const percP = dTotal > 0 ? Math.round((dPago / dTotal) * 100) : 0;
            const barP = document.getElementById("barDespesaPago");
            const barD = document.getElementById("barDespesaPendente");
            
            if(barP) { barP.style.width = percP + "%"; barP.innerText = percP + "%"; }
            if(barD) { barD.style.width = (100 - percP) + "%"; barD.innerText = (100 - percP) + "%"; }
            
            document.getElementById("qtdPago").innerText = qPago;
            document.getElementById("qtdPendente").innerText = qPend;
        }*/

        function classeVencimento(item) {
            if (item.tipo !== "Despesa" || item.status === "PAGO") return "";
            const dItem = new Date(item.data + "T12:00:00");
            const hoje = new Date(); hoje.setHours(0,0,0,0); dItem.setHours(0,0,0,0);
            if (dItem < hoje) return "vencida";
            if (dItem.getTime() === hoje.getTime()) return "hoje";
            return "futura";
        }

        async function adicionar() {
            if (!fData.value || !fDesc.value || !fValor.value) return mostrarToast("‚ùå Preencha tudo");
            const chkRec = document.getElementById("chkRecorrente").checked;
            const qtd = chkRec ? Number(document.getElementById("qtdRecorrencia").value) : 1;
            
            for (let i = 0; i < qtd; i++) {
                const d = new Date(fData.value + "T12:00:00");
                d.setMonth(d.getMonth() + i);
                const payload = {
                    action: "addLancamento",
                    data: d.toISOString().slice(0, 10),
                    desc: fDesc.value,
                    valor: Number(fValor.value),
                    tipo: fTipo.value,
                    user: userNow
                };
                await fetch(URL_API, { method: "POST", body: JSON.stringify(payload) });
            }
            carregar();
            mostrarToast("‚úÖ Salvo");
        }

        async function togglePago(id) {
            const item = db.find(x => String(x.id) === String(id));
            if (!item) return;
            item.status = (item.status === "PAGO" ? "PENDENTE" : "PAGO");
            await fetch(URL_API, { method: "POST", body: JSON.stringify({ action: "updatePago", id: id, status: item.status }) });
            render();
        }

        async function excluir(id) {
            if (!confirm("Excluir?")) return;
            await fetch(URL_API, { method: "POST", body: JSON.stringify({ action: "deleteLancamento", id: id }) });
            db = db.filter(x => String(x.id) !== String(id));
            render();
        }

        function toggleRecorrencia() {
            document.getElementById("qtdRecorrencia").disabled = !document.getElementById("chkRecorrente").checked;
        }

        async function abrirSalario() { new bootstrap.Modal(document.getElementById('modalSalario')).show(); }

        async function salvarSalario() {
            const s05 = document.getElementById("sal05").value;
            const s20 = document.getElementById("sal20").value;
            const mes = new Date().toISOString().slice(0, 7);
            
            if(s05 > 0) await fetch(URL_API, { method: "POST", body: JSON.stringify({ action: "addLancamento", data: `${mes}-05`, desc: "Sal√°rio", valor: Number(s05), tipo: "Receita", user: userNow })});
            if(s20 > 0) await fetch(URL_API, { method: "POST", body: JSON.stringify({ action: "addLancamento", data: `${mes}-20`, desc: "Adiantamento", valor: Number(s20), tipo: "Receita", user: userNow })});
            
            carregar();
        }

        function renderHistorico() {
            const filtro = document.getElementById("histFiltro").value;
            const ano = Number(document.getElementById("histAno").value);
            const corpo = document.getElementById("corpoHist");
            corpo.innerHTML = "";
            const hist = {};

            db.forEach(l => {
                const [y, m] = l.data.split("-").map(Number);
                if (y !== ano) return;
                if (filtro === "s1" && m > 6) return;
                if (filtro === "s2" && m <= 6) return;
                const chave = `${y}-${String(m).padStart(2, "0")}`;
                if (!hist[chave]) hist[chave] = { r: 0, d: 0 };
                l.tipo === "Receita" ? hist[chave].r += l.valor : hist[chave].d += l.valor;
            });

            const meses = Object.keys(hist).sort();
            meses.forEach(m => {
                const s = hist[m].r - hist[m].d;
                corpo.innerHTML += `<tr><td>${m}</td><td class="val-receita">R$ ${hist[m].r.toFixed(2)}</td><td class="val-despesa">R$ ${hist[m].d.toFixed(2)}</td><td class="${s >= 0 ? 'val-receita' : 'val-despesa'}">R$ ${s.toFixed(2)}</td></tr>`;
            });
            renderGraficoHistorico(hist, meses);
        }

         function renderGraficoHistorico(hist, meses) {
            const ctx = document.getElementById("graficoMensal").getContext("2d");
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: meses,
                    datasets: [
                        { label: "Receitas", data: meses.map(m => hist[m].r), backgroundColor: "#27ae60" },
                        { label: "Despesas", data: meses.map(m => hist[m].d), backgroundColor: "#e74c3c" }
                    ]
                }
            });
        }

      let grafico; // Certifique-se de declarar no escopo global ou topo do script

    function renderGraficoHistorico(hist, meses) {
    const ctx = document.getElementById("graficoMensal").getContext("2d");
    
    // Destr√≥i o gr√°fico anterior se existir para evitar bugs visuais
    if (grafico) {
        grafico.destroy();
    }

    const labels = meses.map(m => {
        const [y, mes] = m.split("-");
        return MESES_ABREV[parseInt(mes) - 1] + "/" + y.slice(2);
    });

    const receitas = meses.map(m => hist[m].r);
    const despesas = meses.map(m => hist[m].d);
    const saldos = meses.map(m => hist[m].r - hist[m].d);

    grafico = new Chart(ctx, {
        data: {
            labels: labels,
            datasets: [
                {
                    type: 'line',
                    label: 'Saldo L√≠quido',
                    data: saldos,
                    borderColor: '#6c5ce7',
                    backgroundColor: '#6c5ce7',
                    borderWidth: 3,
                    pointRadius: 4,
                    tension: 0.4,
                    order: 1
                },
                {
                    type: 'bar',
                    label: 'Receitas',
                    data: receitas,
                    backgroundColor: '#2ecc71',
                    borderRadius: 5,
                    order: 2
                },
                {
                    type: 'bar',
                    label: 'Despesas',
                    data: despesas,
                    backgroundColor: '#ff7675',
                    borderRadius: 5,
                    order: 3
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-br');
                        }
                    }
                }
            }
        }
    });
}
        
async function carregarAssinaturas() {
    try {
        const r = await fetch(`${URL_API}?action=listarAssinaturas`);
        const dados = await r.json();
        const corpo = document.getElementById("corpoAss");
        const totalEl = document.getElementById("totalAss");
        
        corpo.innerHTML = "";
        let somaAtivas = 0;

        dados.forEach(a => {
            // Estrutura: [ID, Nome, DiaVenc, Valor, Cartao, User, Status]
            const valor = Number(a[3]) || 0;
            const status = a[6] || "Ativo";

            if (status === "Ativo") {
                somaAtivas += valor;
            }

            corpo.innerHTML += `
                <tr>
                    <td>${a[1]}</td>
                    <td>Dia ${a[2]}</td>
                    <td class="fw-bold">R$ ${valor.toFixed(2)}</td>
                    <td><span class="badge bg-light text-dark">${a[4] || '-'}</span></td>
                    <td class="text-muted">R$ ${(valor * 12).toFixed(2)}</td>
                    <td><span class="badge ${status === 'Ativo' ? 'bg-success' : 'bg-danger'}">${status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="excluirAssinatura('${a[0]}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
        });

        totalEl.innerText = `R$ ${somaAtivas.toFixed(2)}`;
    } catch (e) {
        console.error("Erro ao carregar assinaturas:", e);
    }
}

// Lembre-se de adicionar a fun√ß√£o de excluir para as assinaturas tamb√©m
async function excluirAssinatura(id) {
    if (!confirm("Remover esta assinatura?")) return;
    await fetch(URL_API, { method: "POST", body: JSON.stringify({ action: "deleteAssinatura", id: id }) });
    carregarAssinaturas();
    mostrarToast("üóëÔ∏è Assinatura removida");
}
        
        async function addAssinatura() {
            const payload = {
                action: "addAssinatura",
                nome: document.getElementById("aNome").value,
                venc: document.getElementById("aVenc").value,
                valor: document.getElementById("aValor").value,
                cartao: document.getElementById("aCartao").value,
                status: document.getElementById("aStatus").value,
                user: userNow
            };
            await fetch(URL_API, { method: "POST", body: JSON.stringify(payload) });
            carregarAssinaturas();
        }
    </script>
</body>
</html>
