<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Controle Financeiro Online</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #f0f2f5; padding-top: 70px; font-family: 'Segoe UI', sans-serif; }
        .nav-top { background: #1a252f; padding: 12px; position: fixed; top: 0; width: 100%; z-index: 1000; display: flex; justify-content: center; gap: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .container-box { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .hidden { display: none; }
        .card-resumo { border-radius: 12px; color: white; padding: 15px; text-align: center; }
        .bg-receita { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .bg-despesa { background: linear-gradient(135deg, #e74c3c, #ff7675); }
        .bg-saldo { background: linear-gradient(135deg, #2c3e50, #34495e); }
        .val-receita { color: #27ae60; font-weight: bold; }
        .val-despesa { color: #e74c3c; font-weight: bold; }
        .status-pago { color: #27ae60; font-weight: bold; font-size: 0.8rem; }
        .status-pendente { color: #f39c12; font-weight: bold; font-size: 0.8rem; }
        label { font-size: 0.75rem; text-transform: uppercase; color: #7f8c8d; font-weight: bold; }
        .month-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 8px; margin-top: 10px; }
        .btn-month { border: 1px solid #dee2e6; background: white; padding: 8px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; }
        .btn-month.active { background: #1a252f; color: white; border-color: #1a252f; }
        .filtro-ano-mini { width: auto; min-width: 80px; max-width: 100px; display: inline-block; height: 28px; font-size: 0.8rem; padding: 2px 5px; }
        /* Indicador de salvamento */
        #status-cloud { position: fixed; bottom: 10px; right: 10px; font-size: 0.7rem; padding: 5px 10px; border-radius: 20px; background: #eee; z-index: 2000; }
    </style>
</head>
<body>

<div id="status-cloud">â˜ï¸ Sincronizado</div>

<nav class="nav-top">
    <button class="btn btn-light btn-sm px-4 fw-bold" onclick="showPage('historia')">ğŸ“Š HISTÃ“RICO</button>
    <button class="btn btn-light btn-sm px-4 fw-bold" onclick="showPage('lancamentos')">ğŸ’¸ LANÃ‡AMENTOS</button>
</nav>

<div id="pg-historia" class="container">
    <div class="container-box">
        <div class="row g-2 align-items-end">
            <div class="col-6 col-md-3"><label>ğŸ“… Filtrar Ano</label><select id="filtro-ano-hist" class="form-select" onchange="render()"></select></div>
            <div class="col-6 col-md-3"><label>ğŸŒ“ PerÃ­odo</label>
                <select id="filtro-semestre" class="form-select" onchange="render()">
                    <option value="todos">Ano Inteiro</option><option value="1">1Âº Semestre</option><option value="2">2Âº Semestre</option>
                </select>
            </div>
        </div>
    </div>
    <div class="container-box text-center">
        <h5 class="fw-bold mb-3">ğŸ“ˆ EVOLUÃ‡ÃƒO NO DRIVE</h5>
        <div style="height: 300px;"><canvas id="chartHist"></canvas></div>
    </div>
    <div class="container-box table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-dark"><tr><th>ğŸ—“ï¸ MÃªs/Ano</th><th>ğŸ“ˆ Receita</th><th>ğŸ“‰ Despesa</th><th>ğŸ’° Saldo</th></tr></thead>
            <tbody id="corpo-historia"></tbody>
        </table>
    </div>
</div>

<div id="pg-lancamentos" class="container hidden">
    <div class="container-box">
        <div class="d-flex flex-column gap-1">
            <label>ğŸ” Selecionar MÃªs e Ano</label>
            <select id="f-ano-lanc" class="form-select filtro-ano-mini" onchange="initMonthSelector()"></select>
        </div>
        <div class="month-grid" id="month-selector"></div>
        <input type="hidden" id="mes-foco">
    </div>

    <div class="row g-2 mb-3 text-uppercase fw-bold">
        <div class="col-4"><div class="card-resumo bg-receita"><small>Ganhos</small><div id="res-rec">R$ 0</div></div></div>
        <div class="col-4"><div class="card-resumo bg-despesa"><small>Gastos</small><div id="res-des">R$ 0</div></div></div>
        <div class="col-4"><div class="card-resumo bg-saldo"><small>Sobra</small><div id="res-sal">R$ 0</div></div></div>
    </div>

    <div class="container-box">
        <input type="hidden" id="edit-id">
        <div class="row g-2">
            <div class="col-6 col-md-2"><label>ğŸ“… Data</label><input type="date" id="f-data" class="form-control"></div>
            <div class="col-6 col-md-3"><label>ğŸ“ DescriÃ§Ã£o</label><input type="text" id="f-desc" class="form-control" placeholder="Ex: Mercado"></div>
            <div class="col-6 col-md-2"><label>ğŸ’µ Valor</label><input type="number" id="f-valor" class="form-control" placeholder="0.00"></div>
            <div class="col-6 col-md-2"><label>âš™ï¸ Tipo</label>
                <select id="f-tipo" class="form-select"><option value="Receita">Receita</option><option value="Despesa" selected>Despesa</option></select>
            </div>
            <div class="col-12 col-md-3 d-flex align-items-end"><button id="btn-main" class="btn btn-dark w-100 fw-bold" onclick="adicionar()">â• INCLUIR NO DRIVE</button></div>
            <div class="col-12 mt-2">
                <input type="checkbox" id="f-rec-check" onchange="document.getElementById('box-parc').classList.toggle('hidden', !this.checked)"> ğŸ” Parcelar?
                <div id="box-parc" class="hidden mt-2 p-2 border rounded bg-light"><label>Meses</label><input type="number" id="f-parc" class="form-control w-25" value="1"></div>
            </div>
        </div>
    </div>

    <div class="container-box table-responsive">
        <table class="table table-sm align-middle table-hover">
            <tbody id="corpo-itens" class="small"></tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- PASSO 3: CONFIGURAÃ‡ÃƒO DO GOOGLE DRIVE ---
    const URL_GOOGLE_SCRIPT = "https://script.google.com/macros/s/AKfycbwAPPjSGWDTPtO1FEJgSYJ-dAZbXgDy61GeKuxUc5WxdhWgsL5QUDYbuR_7CrGscjsk/exec";

    let db = [];
    let chartH = null;

    // FunÃ§Ã£o para Salvar na Nuvem
    async function salvarNoDrive() {
        document.getElementById('status-cloud').innerText = "â³ Salvando...";
        try {
            await fetch(URL_GOOGLE_SCRIPT, {
                method: 'POST',
                mode: 'no-cors', // NecessÃ¡rio para o Google Apps Script
                body: JSON.stringify(db)
            });
            document.getElementById('status-cloud').innerText = "â˜ï¸ Sincronizado";
        } catch (e) {
            document.getElementById('status-cloud').innerText = "âŒ Erro ao sincronizar";
        }
    }

    // FunÃ§Ã£o para Carregar da Nuvem
    async function carregarDoDrive() {
        document.getElementById('status-cloud').innerText = "â³ Carregando Drive...";
        try {
            const response = await fetch(URL_GOOGLE_SCRIPT);
            const dados = await response.json();
            if (dados && dados.length > 0) {
                db = dados;
                render();
            }
            document.getElementById('status-cloud').innerText = "â˜ï¸ Online";
        } catch (e) {
            document.getElementById('status-cloud').innerText = "âš ï¸ Modo Offline";
        }
    }

    function initFilters() {
        const anoAtual = new Date().getFullYear();
        const selHist = document.getElementById('filtro-ano-hist');
        const selLanc = document.getElementById('f-ano-lanc');
        [selHist, selLanc].forEach(s => {
            s.innerHTML = "";
            for(let i = anoAtual - 1; i <= anoAtual + 2; i++) {
                s.innerHTML += `<option value="${i}" ${i === anoAtual ? 'selected' : ''}>${i}</option>`;
            }
        });
    }

    function initMonthSelector() {
        const grid = document.getElementById('month-selector');
        const ano = document.getElementById('f-ano-lanc').value;
        const meses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        const mesAtual = new Date().getMonth();
        grid.innerHTML = "";
        meses.forEach((m, i) => {
            const valor = `${ano}-${String(i+1).padStart(2, '0')}`;
            grid.innerHTML += `<button class="btn-month ${i === mesAtual ? 'active' : ''}" onclick="setMesFoco('${valor}', this)">${m}</button>`;
        });
        document.getElementById('mes-foco').value = `${ano}-${String(mesAtual+1).padStart(2, '0')}`;
        render();
    }

    function setMesFoco(valor, btn) {
        document.querySelectorAll('.btn-month').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('mes-foco').value = valor;
        render();
    }

    function showPage(pg) {
        document.getElementById('pg-historia').classList.toggle('hidden', pg !== 'historia');
        document.getElementById('pg-lancamentos').classList.toggle('hidden', pg !== 'lancamentos');
        render();
    }

    function adicionar() {
        const editId = document.getElementById('edit-id').value;
        const dataVal = document.getElementById('f-data').value;
        const descBase = document.getElementById('f-desc').value;
        const valorVal = parseFloat(document.getElementById('f-valor').value);
        const tipoVal = document.getElementById('f-tipo').value;
        const numParc = parseInt(document.getElementById('f-parc').value) || 1;

        if (!dataVal || isNaN(valorVal)) return alert("Preencha Data e Valor!");

        if (editId) {
            let index = db.findIndex(x => x.id == editId);
            db[index] = { ...db[index], data: dataVal, desc: descBase, valor: valorVal, tipo: tipoVal };
        } else {
            for(let i=0; i < numParc; i++) {
                let d = new Date(dataVal + "T00:00:00");
                d.setMonth(d.getMonth() + i);
                db.push({ id: Date.now() + i, data: d.toISOString().split('T')[0], desc: descBase + (numParc > 1 ? ` [${i+1}/${numParc}]` : ""), valor: valorVal, tipo: tipoVal, pago: false });
            }
        }
        salvar();
    }

    function togglePago(id) {
        let item = db.find(x => x.id === id);
        item.pago = !item.pago;
        salvar();
    }

    function deletar(id) { if(confirm("Excluir?")) { db = db.filter(x => x.id !== id); salvar(); } }

    function salvar() {
        localStorage.setItem('financas_pro_v6', JSON.stringify(db));
        render();
        salvarNoDrive(); // Envia para o Google Sheets
    }

    function render() {
        const mesFoco = document.getElementById('mes-foco').value;
        const corpoI = document.getElementById('corpo-itens');
        const corpoH = document.getElementById('corpo-historia');
        corpoI.innerHTML = ""; corpoH.innerHTML = "";
        let rMes = 0, dMes = 0, hist = {};

        db.sort((a,b) => new Date(a.data) - new Date(b.data)).forEach(item => {
            const mD = item.data.substring(0,7);
            if(!hist[mD]) hist[mD] = {r:0, d:0};
            if(item.tipo === "Receita") hist[mD].r += item.valor; else hist[mD].d += item.valor;

            if(mD === mesFoco) {
                if(item.tipo === "Receita") rMes += item.valor; else dMes += item.valor;
                corpoI.innerHTML += `<tr>
                    <td><input type="checkbox" class="form-check-input" ${item.pago?'checked':''} onclick="togglePago(${item.id})"></td>
                    <td><b>${item.data.split('-').reverse().join('/')}</b><br>${item.desc}</td>
                    <td class="${item.tipo==='Receita'?'val-receita':'val-despesa'}">R$ ${item.valor.toFixed(2)}</td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="deletar(${item.id})">ğŸ—‘ï¸</button></td>
                </tr>`;
            }
        });

        Object.keys(hist).sort().reverse().forEach(m => {
            const s = hist[m];
            corpoH.innerHTML += `<tr><td>${m}</td><td class="val-receita">R$ ${s.r.toFixed(2)}</td><td class="val-despesa">R$ ${s.d.toFixed(2)}</td><td class="fw-bold">R$ ${(s.r-s.d).toFixed(2)}</td></tr>`;
        });

        document.getElementById('res-rec').innerText = "R$ " + rMes.toFixed(2);
        document.getElementById('res-des').innerText = "R$ " + dMes.toFixed(2);
        document.getElementById('res-sal').innerText = "R$ " + (rMes - dMes).toFixed(2);

        if(chartH) chartH.destroy();
        chartH = new Chart(document.getElementById('chartHist'), {
            data: {
                labels: Object.keys(hist).sort(),
                datasets: [
                    { type: 'line', label: 'Saldo', data: Object.keys(hist).sort().map(l => hist[l].r - hist[l].d), borderColor: '#2c3e50' },
                    { type: 'bar', label: 'Ganhos', data: Object.keys(hist).sort().map(l => hist[l].r), backgroundColor: '#27ae60' },
                    { type: 'bar', label: 'Gastos', data: Object.keys(hist).sort().map(l => hist[l].d), backgroundColor: '#e74c3c' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    window.onload = () => { 
        initFilters(); 
        initMonthSelector(); 
        carregarDoDrive(); // Busca os dados do Google Drive ao abrir
    };
</script>
</body>
</html>
