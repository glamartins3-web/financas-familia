<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Controle Financeiro Pro Online</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #f0f2f5; padding-top: 70px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #tela-login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a252f; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .nav-top { background: #1a252f; padding: 12px; position: fixed; top: 0; width: 100%; z-index: 1000; display: flex; justify-content: center; gap: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .container-box { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .hidden { display: none !important; }
        .card-resumo { border-radius: 12px; color: white; padding: 15px; text-align: center; }
        .bg-receita { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .bg-despesa { background: linear-gradient(135deg, #e74c3c, #ff7675); }
        .bg-saldo { background: linear-gradient(135deg, #2c3e50, #34495e); }
        .val-receita { color: #27ae60; font-weight: bold; }
        .val-despesa { color: #e74c3c; font-weight: bold; }
        .btn-edit { color: #3498db; cursor: pointer; border: none; background: none; font-size: 1.1rem; }
        .btn-del { color: #e74c3c; cursor: pointer; border: none; background: none; font-size: 1.1rem; }
        label { font-size: 0.75rem; text-transform: uppercase; color: #7f8c8d; font-weight: bold; }
        .month-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 8px; margin-top: 10px; }
        .btn-month { border: 1px solid #dee2e6; background: white; padding: 8px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; }
        .btn-month.active { background: #1a252f; color: white; border-color: #1a252f; }
        #status-nuvem { position: fixed; bottom: 10px; right: 10px; z-index: 2000; font-size: 0.7rem; padding: 4px 8px; border-radius: 10px; background: rgba(255,255,255,0.8); border: 1px solid #ccc; }
    </style>
</head>
<body>

<div id="tela-login">
    <div class="login-box">
        <h4 class="fw-bold mb-3">ACESSO RESTRITO</h4>
        <input type="text" id="user-input" class="form-control mb-2" placeholder="Usu√°rio">
        <input type="password" id="pass-input" class="form-control mb-3" placeholder="Senha">
        <button class="btn btn-dark w-100 fw-bold" onclick="fazerLogin()">ENTRAR</button>
        <div id="login-error" class="text-danger mt-2 small hidden">Usu√°rio ou senha inv√°lidos!</div>
    </div>
</div>

<div id="app-content" class="hidden">
    <div id="status-nuvem">‚òÅÔ∏è Carregando...</div>
    <nav class="nav-top">
        <button class="btn btn-light btn-sm px-4 fw-bold" onclick="showPage('historia')">üìä HIST√ìRICO</button>
        <button class="btn btn-light btn-sm px-4 fw-bold" onclick="showPage('lancamentos')">üí∏ LAN√áAMENTOS</button>
        <button class="btn btn-outline-danger btn-sm border-0" onclick="logout()">üö™</button>
    </nav>

    <div id="pg-historia" class="container">
        <div class="container-box">
            <div class="row g-2 align-items-end">
                <div class="col-6 col-md-3"><label>üìÖ Ano</label><select id="filtro-ano-hist" class="form-select" onchange="render()"></select></div>
                <div class="col-6 col-md-3"><label>üåì Per√≠odo</label>
                    <select id="filtro-semestre" class="form-select" onchange="render()">
                        <option value="todos">Ano Inteiro</option>
                        <option value="1">1¬∫ Semestre</option>
                        <option value="2">2¬∫ Semestre</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="container-box text-center">
            <h5 class="fw-bold mb-3">üìà EVOLU√á√ÉO (ONLINE)</h5>
            <div style="height: 250px;"><canvas id="chartHist"></canvas></div>
        </div>
        <div class="container-box table-responsive">
            <table class="table table-sm align-middle">
                <thead class="table-dark"><tr><th>M√™s/Ano</th><th>Ganhos</th><th>Gastos</th><th>Saldo</th></tr></thead>
                <tbody id="corpo-historia"></tbody>
                <tfoot id="total-historia" class="fw-bold bg-light"></tfoot>
            </table>
        </div>
    </div>

    <div id="pg-lancamentos" class="container hidden">
        <div class="container-box">
            <select id="f-ano-lanc" class="form-select mb-2" onchange="initMonthSelector()"></select>
            <div class="month-grid" id="month-selector"></div>
            <input type="hidden" id="mes-foco">
        </div>

        <div class="row g-2 mb-3 fw-bold text-center">
            <div class="col-4"><div class="card-resumo bg-receita"><small>Ganhos</small><div id="res-rec">0</div></div></div>
            <div class="col-4"><div class="card-resumo bg-despesa"><small>Gastos</small><div id="res-des">0</div></div></div>
            <div class="col-4"><div class="card-resumo bg-saldo"><small>Sobra</small><div id="res-sal">0</div></div></div>
        </div>

        <div class="container-box">
            <input type="hidden" id="edit-id">
            <div class="row g-2">
                <div class="col-6 col-md-2"><label>Data</label><input type="date" id="f-data" class="form-control"></div>
                <div class="col-6 col-md-4"><label>Descri√ß√£o</label><input type="text" id="f-desc" class="form-control"></div>
                <div class="col-6 col-md-2"><label>Valor</label><input type="number" id="f-valor" class="form-control"></div>
                <div class="col-6 col-md-2"><label>Tipo</label>
                    <select id="f-tipo" class="form-select"><option value="Receita">Receita</option><option value="Despesa" selected>Despesa</option></select>
                </div>
                <div class="col-12 col-md-2 d-flex align-items-end"><button id="btn-main" class="btn btn-dark w-100 fw-bold" onclick="adicionar()">‚ûï INCLUIR</button></div>
                <div class="col-12 mt-2">
                    <input type="checkbox" id="f-rec-check" onchange="document.getElementById('box-parc').classList.toggle('hidden', !this.checked)"> Parcelar?
                    <div id="box-parc" class="hidden mt-1"><input type="number" id="f-parc" class="form-control d-inline-block w-25" value="1"> meses</div>
                </div>
            </div>
        </div>

        <div class="container-box table-responsive">
            <table class="table table-sm align-middle table-hover">
                <thead class="table-light"><tr><th>Pago</th><th>Data/Descri√ß√£o</th><th>Valor</th><th>User</th><th>A√ß√µes</th></tr></thead>
                <tbody id="corpo-itens" class="small"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const URL_GOOGLE_SCRIPT = "SUA_URL_AQUI"; // SUBSTITUA PELA SUA URL DO GOOGLE
    const USUARIOS_PERMITIDOS = { "admin": "123", "glauber": "1912", "suelen": "1009" };

    let db = [];
    let chartH = null;
    let usuarioLogado = "";

    function fazerLogin() {
        const u = document.getElementById('user-input').value.toLowerCase();
        const p = document.getElementById('pass-input').value;
        if (USUARIOS_PERMITIDOS[u] && USUARIOS_PERMITIDOS[u] === p) {
            usuarioLogado = u;
            sessionStorage.setItem('sessao_financeira', u);
            document.getElementById('tela-login').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            carregarDoDrive();
        } else {
            document.getElementById('login-error').classList.remove('hidden');
        }
    }

    function logout() { sessionStorage.clear(); location.reload(); }

    async function carregarDoDrive() {
        document.getElementById('status-nuvem').innerText = "‚è≥ Lendo...";
        try {
            const res = await fetch(URL_GOOGLE_SCRIPT);
            const dados = await res.json();
            db = Array.isArray(dados) ? dados.map(item => ({ ...item, data: String(item.data).split('T')[0] })) : [];
            render();
            document.getElementById('status-nuvem').innerText = "‚òÅÔ∏è " + usuarioLogado;
        } catch (e) {
            db = JSON.parse(localStorage.getItem('financas_pro_v6')) || [];
            render();
        }
    }

    async function salvar() {
        localStorage.setItem('financas_pro_v6', JSON.stringify(db));
        render();
        try {
            await fetch(URL_GOOGLE_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify(db) });
            document.getElementById('status-nuvem').innerText = "‚òÅÔ∏è Sincronizado";
        } catch(e) { document.getElementById('status-nuvem').innerText = "‚ö†Ô∏è Erro Nuvem"; }
    }

    function adicionar() {
        const id = document.getElementById('edit-id').value;
        const data = document.getElementById('f-data').value;
        const desc = document.getElementById('f-desc').value;
        const valor = parseFloat(document.getElementById('f-valor').value);
        const tipo = document.getElementById('f-tipo').value;
        const parc = parseInt(document.getElementById('f-parc').value) || 1;

        if (!data || isNaN(valor)) return alert("Dados inv√°lidos");

        if (id) {
            let idx = db.findIndex(x => x.id == id);
            db[idx] = { ...db[idx], data, desc, valor, tipo, responsavel: usuarioLogado };
        } else {
            for(let i=0; i<parc; i++) {
                let d = new Date(data + "T00:00:00"); d.setMonth(d.getMonth() + i);
                db.push({ id: Date.now()+i, data: d.toISOString().split('T')[0], desc: desc + (parc>1?` [${i+1}/${parc}]`:''), valor, tipo, pago: false, responsavel: usuarioLogado });
            }
        }
        limpar(); salvar();
    }

    function editar(id) {
        let item = db.find(x => x.id == id);
        document.getElementById('edit-id').value = item.id;
        document.getElementById('f-data').value = item.data;
        document.getElementById('f-desc').value = item.desc.split(' [')[0];
        document.getElementById('f-valor').value = item.valor;
        document.getElementById('f-tipo').value = item.tipo;
        const btn = document.getElementById('btn-main');
        btn.innerText = "‚úèÔ∏è SALVAR"; btn.classList.replace('btn-dark', 'btn-success');
        window.scrollTo(0,0);
    }

    function deletar(id) { if(confirm("Excluir?")) { db = db.filter(x => x.id != id); salvar(); } }

    function togglePago(id) {
        let item = db.find(x => x.id == id);
        item.pago = !item.pago;
        salvar();
    }

    function limpar() {
        document.getElementById('edit-id').value = "";
        document.getElementById('f-desc').value = "";
        document.getElementById('f-valor').value = "";
        const btn = document.getElementById('btn-main');
        btn.innerText = "‚ûï INCLUIR"; btn.classList.replace('btn-success', 'btn-dark');
    }

    function render() {
        const mesFoco = document.getElementById('mes-foco').value;
        const anoH = document.getElementById('filtro-ano-hist').value;
        const corpoI = document.getElementById('corpo-itens');
        const corpoH = document.getElementById('corpo-historia');
        corpoI.innerHTML = ""; corpoH.innerHTML = "";
        let rMes = 0, dMes = 0, hist = {};

        db.sort((a,b) => new Date(a.data) - new Date(b.data)).forEach(item => {
            const mD = item.data.substring(0,7);
            const aD = item.data.substring(0,4);
            
            if(aD === anoH) {
                if(!hist[mD]) hist[mD] = {r:0, d:0};
                if(item.tipo === "Receita") hist[mD].r += item.valor; else hist[mD].d += item.valor;
            }

            if (mD === mesFoco) {
                if(item.tipo === "Receita") rMes += item.valor; else dMes += item.valor;
                corpoI.innerHTML += `<tr>
                    <td><input type="checkbox" ${item.pago?'checked':''} onclick="togglePago(${item.id})"></td>
                    <td><b>${item.data.split('-').reverse().join('/')}</b><br>${item.desc}</td>
                    <td class="${item.tipo==='Receita'?'val-receita':'val-despesa'}">R$ ${item.valor.toFixed(2)}</td>
                    <td><small>${item.responsavel || '---'}</small></td>
                    <td><button class="btn-edit" onclick="editar(${item.id})">‚úèÔ∏è</button><button class="btn-del" onclick="deletar(${item.id})">üóëÔ∏è</button></td>
                </tr>`;
            }
        });

        Object.keys(hist).sort().reverse().forEach(m => {
            corpoH.innerHTML += `<tr><td>${m}</td><td class="val-receita">R$ ${hist[m].r.toFixed(2)}</td><td class="val-despesa">R$ ${hist[m].d.toFixed(2)}</td><td>R$ ${(hist[m].r-hist[m].d).toFixed(2)}</td></tr>`;
        });

        document.getElementById('res-rec').innerText = "R$ " + rMes.toFixed(2);
        document.getElementById('res-des').innerText = "R$ " + dMes.toFixed(2);
        document.getElementById('res-sal').innerText = "R$ " + (rMes - dMes).toFixed(2);

        if(chartH) chartH.destroy();
        const ctx = document.getElementById('chartHist');
        if(ctx) {
            chartH = new Chart(ctx, {
                data: {
                    labels: Object.keys(hist).sort(),
                    datasets: [
                        { type: 'line', label: 'Saldo', data: Object.keys(hist).sort().map(l => hist[l].r - hist[l].d), borderColor: '#2c3e50' },
                        { type: 'bar', label: 'Ganhos', data: Object.keys(hist).sort().map(l => hist[l].r), backgroundColor: '#27ae60' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    }

    function showPage(pg) {
        document.getElementById('pg-historia').classList.toggle('hidden', pg !== 'historia');
        document.getElementById('pg-lancamentos').classList.toggle('hidden', pg !== 'lancamentos');
        render();
    }

    function initFilters() {
        const ano = new Date().getFullYear();
        ['filtro-ano-hist', 'f-ano-lanc'].forEach(id => {
            const el = document.getElementById(id);
            for(let i=ano-1; i<=ano+2; i++) el.innerHTML += `<option value="${i}" ${i==ano?'selected':''}>${i}</option>`;
        });
    }

    function initMonthSelector() {
        const grid = document.getElementById('month-selector');
        const ano = document.getElementById('f-ano-lanc').value;
        const meses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        grid.innerHTML = "";
        meses.forEach((m, i) => {
            const valor = `${ano}-${String(i+1).padStart(2, '0')}`;
            grid.innerHTML += `<button class="btn-month ${i==new Date().getMonth()?'active':''}" onclick="setMesFoco('${valor}', this)">${m}</button>`;
        });
        document.getElementById('mes-foco').value = `${ano}-${String(new Date().getMonth()+1).padStart(2, '0')}`;
        render();
    }

    function setMesFoco(v, b) {
        document.querySelectorAll('.btn-month').forEach(x => x.classList.remove('active'));
        b.classList.add('active'); document.getElementById('mes-foco').value = v; render();
    }

    window.onload = () => {
        initFilters();
        initMonthSelector();
        const sessao = sessionStorage.getItem('sessao_financeira');
        if (sessao) {
            usuarioLogado = sessao;
            document.getElementById('tela-login').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            carregarDoDrive();
        }
    };
</script>
</body>
</html>
